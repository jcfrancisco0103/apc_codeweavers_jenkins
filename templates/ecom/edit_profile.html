{% extends 'ecom/customer_base.html' %} {% load widget_tweaks %} {% load static %} {% block content %}

<head>
    <style media="screen">
        body {
            background-color: #ffffff;
        }
        
        a:link {
            text-decoration: none;
        }
        
        .note {
            text-align: center;
            height: 80px;
            background: -webkit-linear-gradient(left, #0072ff, #8811c5);
            color: #fff;
            font-weight: bold;
            line-height: 80px;
        }
        
        .form-content {
            padding: 5%;
            border: 1px solid #ced4da;
            margin-bottom: 2%;
        }
        
        .form-control {
            border-radius: 1.5rem;
        }
        
        .btnSubmit {
            border: none;
            border-radius: 1.5rem;
            padding: 1%;
            width: 20%;
            cursor: pointer;
            background: #005d94;
            color: #fff;
        }
        
        .menu {
            top: 50px;
        }

        .edit-profile-card {
            max-width: 700px;
            margin: 40px auto 60px auto;
            background: #fff;
            border-radius: 18px;
            box-shadow: 0 4px 24px rgba(0,0,0,0.10);
            padding: 36px 32px 28px 32px;
        }
        .edit-profile-title {
            font-size: 2rem;
            font-weight: 700;
            color: #005d94;
            margin-bottom: 18px;
            text-align: center;
            letter-spacing: 1px;
        }
        .edit-profile-form .form-group {
            margin-bottom: 18px;
            position: relative;
        }
        .edit-profile-form .form-control {
            border-radius: 1.2rem;
            padding-left: 45px; /* reduced from 38px to 32px */
            font-size: 1rem;
            box-shadow: none;
            border: 1px solid #d1d5db;
            background: #f8fafc;
            transition: border 0.2s;
        }
        .edit-profile-form .form-control:focus {
            border: 1.5px solid #005d94;
            background: #fff;
        }
        .edit-profile-form .input-icon {
            position: absolute;
            left: 6px; /* moved from 12px to 6px */
            top: 50%;
            transform: translateY(-50%);
            color: #b0b0b0;
            font-size: 1.1rem;
            pointer-events: none;
            z-index: 2;
        }
        .edit-profile-form .btnSubmit {
            border: none;
            border-radius: 1.5rem;
            padding: 10px 36px;
            background: linear-gradient(90deg, #0072ff 0%, #005d94 100%);
            color: #fff;
            font-weight: 600;
            font-size: 1.1rem;
            margin-top: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            transition: background 0.2s;
        }
        .edit-profile-form .btnSubmit:hover {
            background: linear-gradient(90deg, #005d94 0%, #0072ff 100%);
        }
        @media (max-width: 600px) {
            .edit-profile-card { padding: 18px 6px; }
        }
    </style>
    <script src="{% static 'js/ph-address-cascade-api.js' %}"></script>
    <script>
      // Pass initial values from Django to JS
      const initialRegion = "{{ customerForm.region.value|escapejs }}";
      const initialProvince = "{{ customerForm.province.value|escapejs }}";
      const initialCitymun = "{{ customerForm.citymun.value|escapejs }}";
      const initialBarangay = "{{ customerForm.barangay.value|escapejs }}";

      // Map PSA region codes to Django codes
      const regionCodeMap = {
        '130000000': 'NCR',
        '140000000': 'CAR',
        '010000000': 'R1',
        '020000000': 'R2',
        '030000000': 'R3',
        '040000000': 'R4A',
        '170000000': 'R4B',
        '050000000': 'R5',
        '060000000': 'R6',
        '070000000': 'R7',
        '080000000': 'R8',
        '090000000': 'R9',
        '100000000': 'R10',
        '110000000': 'R11',
        '120000000': 'R12',
        '160000000': 'R13',
        '150000000': 'BARMM'
      };

      function getMappedRegionCode() {
        let psaCode = document.getElementById('region').value;
        if (psaCode.length > 9) psaCode = psaCode.slice(0, 9);
        return regionCodeMap[psaCode] || '';
      }

      document.addEventListener('DOMContentLoaded', function() {
        if (window.initPHAddressCascadeAPI) {
          window.initPHAddressCascadeAPI({
            region: 'region',
            province: 'province',
            citymun: 'citymun',
            barangay: 'barangay'
          });
          // Set initial values after dropdowns are populated
          setTimeout(function() {
            if (initialRegion) {
              document.getElementById('region').value = initialRegion;
              document.getElementById('region').dispatchEvent(new Event('change'));
            }
          }, 300);
          setTimeout(function() {
            if (initialProvince) {
              document.getElementById('province').value = initialProvince;
              document.getElementById('province').dispatchEvent(new Event('change'));
            }
          }, 700);
          setTimeout(function() {
            if (initialCitymun) {
              document.getElementById('citymun').value = initialCitymun;
              document.getElementById('citymun').dispatchEvent(new Event('change'));
            }
          }, 1100);
          setTimeout(function() {
            if (initialBarangay) {
              document.getElementById('barangay').value = initialBarangay;
            }
          }, 1500);
        }

        // On form submit, set region value to Django code using a hidden input
        const form = document.querySelector('form.edit-profile-form');
        let hiddenRegionInput = document.getElementById('region_django_code');
        if (!hiddenRegionInput) {
          hiddenRegionInput = document.createElement('input');
          hiddenRegionInput.type = 'hidden';
          hiddenRegionInput.name = 'region';
          hiddenRegionInput.id = 'region_django_code';
          form.appendChild(hiddenRegionInput);
        }
        if (form) {
          form.addEventListener('submit', function(e) {
            let mapped = getMappedRegionCode();
            if (mapped) {
              hiddenRegionInput.value = mapped;
            } else {
              e.preventDefault();
              alert('Invalid region selected. Please select a valid region.');
            }
          });
        }
      });
    </script>
</head>
<br><br><br><br><br><br>

<div class="edit-profile-card">
    <div class="edit-profile-title">Edit Profile</div>
    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-success" style="margin: 0 auto; width: 80%;">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    <form method="post" enctype="multipart/form-data" class="edit-profile-form">
        {% csrf_token %}
        <div class="row">
            <div class="col-md-6">
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-user"></i></span>
                    {% render_field userForm.first_name class="form-control" placeholder="First Name" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-user"></i></span>
                    {% render_field userForm.last_name class="form-control" placeholder="Last Name" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-user-circle"></i></span>
                    {% render_field userForm.username class="form-control" placeholder="Username" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-lock"></i></span>
                    {% render_field userForm.password class="form-control" placeholder="Password" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-lock"></i></span>
                    {% render_field userForm.confirm_password class="form-control" placeholder="Confirm Password" %}
                </div>
            </div>
            <div class="col-md-6">
                <!-- Address Section: Region, Province, City/Municipality, Barangay -->
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-map"></i></span>
                    {% render_field customerForm.region class="form-control" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-map-marker"></i></span>
                    {% render_field customerForm.province class="form-control" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-building"></i></span>
                    {% render_field customerForm.citymun class="form-control" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-location-arrow"></i></span>
                    {% render_field customerForm.barangay class="form-control" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-home"></i></span>
                    {% render_field customerForm.street_address class="form-control" placeholder="Street Address" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-hashtag"></i></span>
                    {% render_field customerForm.postal_code class="form-control" placeholder="Postal Code" %}
                </div>
                <div class="form-group">
                    <span class="input-icon"><i class="fa fa-phone"></i></span>
                    {% render_field customerForm.mobile class="form-control" id="mobile_number" placeholder="956 837 0169" maxlength="13" minlength="13" pattern="^\d{3} \d{3} \d{4}$" oninput="autoFormatPHMobile(this)" %}
                    <script>
                    function autoFormatPHMobile(input) {
                        let digits = input.value.replace(/\D/g, '');
                        if (digits.length > 3 && digits.length <= 6)
                            input.value = digits.slice(0,3) + ' ' + digits.slice(3);
                        else if (digits.length > 6)
                            input.value = digits.slice(0,3) + ' ' + digits.slice(3,6) + ' ' + digits.slice(6,10);
                        else
                            input.value = digits;
                    }
                    </script>
                </div>
            </div>
        </div>
        <div style="text-align:center;">
            <button type="submit" class="btnSubmit">Save</button>
        </div>
    </form>
</div>

{% endblock content %}