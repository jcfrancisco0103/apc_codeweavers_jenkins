{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorksTeamWear | Jersey Customizer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .apparel-viewport {
            width: 100%;
            height: 700px;
            position: relative;
            perspective: 1200px;
            margin: 0 auto;
        }
        
        .apparel-container {
            width: 100%;
            height: 100%;
            position: absolute;
            transform-style: preserve-3d;
            transition: transform 1s ease;
        }

        #navbar {
        background-color: #000000;
        color: white;
        }
        
        .navbar-input {
        padding: 11px 16px;
        border-radius: 2px 0 0 2px;
        border: 0 none;
        outline: 0 none;
        font-size: 15px;
        color:#000
        }

        .navbar-button {
        background-color: #0c8fc1;
        border: 1px solid #0c8fc1;
        border-radius: 0 2px 2px 0;
        color: #ffffff;
        padding: 10px 0;
        height: 43px;
        cursor: pointer;
        }
        
        .apparel-side {
            position: absolute;
            width: 100%;
            height: 100%;
            backface-visibility: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: #f8f9fa;
            border-radius: 10px;
        }
        
        .apparel-back {
            transform: rotateY(180deg);
        }
        
        .apparel-svg {
            max-width: 90%;
            max-height: 90%;
        }
        
        .controls {
            margin-top: 20px;
            text-align: center;
        }
        
        .logo-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .logo-image {
            position: absolute;
            max-width: 150px;
            max-height: 150px;
            cursor: move;
            pointer-events: auto;
            top: 20%;
            left: 50%;
            transform: translateX(-50%);
        }
        
        .color-swatch {
            width: 30px;
            height: 30px;
            display: inline-block;
            margin: 5px;
            border: 2px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
        }
        
        .color-swatch.active {
            border-color: #000;
        }
        
        .gradient-swatch {
            width: 60px;
            height: 30px;
            display: inline-block;
            margin: 5px;
            border: 2px solid #ddd;
            border-radius: 15px;
            cursor: pointer;
        }
        
        .gradient-swatch.active {
            border-color: #000;
        }
        

         

             transform: translateY(-2px);
             box-shadow: 0 4px 12px rgba(0,0,0,0.15);
         }
         
         .texture-option.active {
             border-color: #1976d2;
             background: #e3f2fd;
             box-shadow: 0 0 0 3px rgba(25,118,210,0.2);
         }
         
         .texture-preview {
             width: 40px;
             height: 40px;
             border-radius: 4px;
             margin-bottom: 5px;
             border: 1px solid #ccc;
         }
         
         .smooth-texture {
             background: linear-gradient(45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(-45deg, #f0f0f0 25%, transparent 25%), 
                        linear-gradient(45deg, transparent 75%, #f0f0f0 75%), 
                        linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
             background-size: 2px 2px;
             background-position: 0 0, 0 1px, 1px -1px, -1px 0px;
         }
         
         .mesh-texture {
             background: radial-gradient(circle at 1px 1px, rgba(0,0,0,0.15) 1px, transparent 0);
             background-size: 4px 4px;
             background-color: #f8f8f8;
         }
         
         .cotton-texture {
             background: repeating-linear-gradient(45deg, #f5f5f5, #f5f5f5 1px, #eeeeee 1px, #eeeeee 3px),
                        repeating-linear-gradient(-45deg, transparent, transparent 1px, rgba(0,0,0,0.05) 1px, rgba(0,0,0,0.05) 3px);
         }
         
         .polyester-texture {
             background: linear-gradient(90deg, #f8f8f8 50%, #f0f0f0 50%),
                        linear-gradient(0deg, #f8f8f8 50%, #f0f0f0 50%);
             background-size: 3px 3px;
         }
         
         .texture-label {
              font-size: 11px;
              font-weight: 500;
              color: #5f6368;
              text-align: center;
          }
          
          /* AI Pattern Generator Styles */
          .pattern-generator {
              background: linear-gradient(135deg, #e8f5e8 0%, #d4edda 100%);
              border: 1px solid #c3e6cb;
              border-radius: 8px;
              padding: 15px;
              margin-top: 10px;
          }
          
          .pattern-types {
              display: grid;
              grid-template-columns: repeat(2, 1fr);
              gap: 10px;
              margin-bottom: 15px;
          }
          
          .pattern-type {
              display: flex;
              flex-direction: column;
              align-items: center;
              padding: 10px;
              border: 2px solid #c3e6cb;
              border-radius: 8px;
              cursor: pointer;
              transition: all 0.3s ease;
              background: white;
          }
          
          .pattern-type:hover {
              transform: translateY(-2px);
              box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          }
          
          .pattern-type.active {
              border-color: #28a745;
              background: #d1ecf1;
              box-shadow: 0 0 0 3px rgba(40,167,69,0.2);
          }
          
          .pattern-preview {
              width: 40px;
              height: 40px;
              border-radius: 4px;
              margin-bottom: 5px;
              border: 1px solid #ccc;
          }
          
          .solid-pattern {
              background: #f8f9fa;
          }
          
          .stripes-pattern {
              background: repeating-linear-gradient(45deg, #007bff, #007bff 4px, #ffffff 4px, #ffffff 8px);
          }
          
          .dots-pattern {
              background: radial-gradient(circle at 25% 25%, #dc3545 2px, transparent 2px),
                         radial-gradient(circle at 75% 75%, #dc3545 2px, transparent 2px);
              background-size: 8px 8px;
              background-color: #ffffff;
          }
          
          .geometric-pattern {
              background: linear-gradient(45deg, #ffc107 25%, transparent 25%),
                         linear-gradient(-45deg, #ffc107 25%, transparent 25%),
                         linear-gradient(45deg, transparent 75%, #ffc107 75%),
                         linear-gradient(-45deg, transparent 75%, #ffc107 75%);
              background-size: 8px 8px;
              background-position: 0 0, 0 4px, 4px -4px, -4px 0px;
              background-color: #ffffff;
          }
          
          .pattern-label {
              font-size: 11px;
              font-weight: 500;
              color: #155724;
              text-align: center;
          }
          
          .pattern-controls {
              background: rgba(255,255,255,0.7);
              border-radius: 6px;
              padding: 10px;
              margin-top: 10px;
          }
          

        
        .rotation-controls {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 10px;
        }
        
        .rotation-slider {
            width: 100%;
            margin-top: 10px;
        }
        
        .logo-controls {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .size-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .logo-size-value {
            font-weight: bold;
        }
        
        .apparel-type-toggle {
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
        }
        
        .apparel-type-toggle .btn {
            min-width: 120px;
        }
        
        .gradient-controls {
            display: none;
            margin-top: 10px;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        
        .gradient-preview {
            height: 30px;
            border-radius: 15px;
            margin-bottom: 10px;
            border: 1px solid #dee2e6;
        }

        .exit-button {
        position: absolute;
        top: 20px;
        right: 20px;
        padding: 10px 15px;
        background-color: red;
        color: white;
        text-decoration: none;
        font-weight: bold;
        border-radius: 5px;
        transition: 0.3s;
    }

    .exit-button:hover {
        background-color: darkred;
    }
    

        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        background: white;
    }
    
    .placement-zone:hover {
        border-color: #007bff;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,123,255,0.2);
    }
    
    .placement-zone.active {
        border-color: #007bff;
        background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
    }
    
    .zone-preview {
        width: 60px;
        height: 40px;
        border-radius: 8px;
        margin-bottom: 8px;
        border: 1px solid #dee2e6;
    }
    
    .chest-preview {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
        position: relative;
    }
    
    .chest-preview::after {
        content: '★';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 16px;
    }
    
    .sleeve-preview {
        background: linear-gradient(135deg, #4ecdc4 0%, #44a08d 100%);
        position: relative;
    }
    
    .sleeve-preview::after {
        content: '◆';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 14px;
    }
    
    .collar-preview {
        background: linear-gradient(135deg, #feca57 0%, #ff9ff3 100%);
        position: relative;
    }
    
    .collar-preview::after {
        content: '▲';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        font-size: 12px;
    }
    
    .back-preview {
        background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);
        position: relative;
    }
    
    .back-preview::after {
        content: '●';
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #333;
        font-size: 16px;
    }
    
    .placement-zone span {
        font-size: 12px;
        font-weight: 500;
        color: #495057;
        text-align: center;
    }
    
    .logo-controls {
        display: flex;
        flex-direction: column;
        gap: 15px;
    }
    
    .logo-controls .control-group {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 8px;
    }
    
    .logo-controls label {
        min-width: 100px;
        font-weight: 500;
        color: #495057;
        margin: 0;
    }
    
    .logo-controls input[type="range"] {
        flex: 1;
        margin: 0 10px;
    }
    
    .logo-controls span {
        min-width: 40px;
        text-align: center;
        font-weight: 600;
        color: #007bff;
    }
    
    .suggest-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border: none;
        padding: 12px 20px;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: center;
        box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    }
    
    .suggest-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
    }
    

    }
    
    .drawing-actions {
        display: flex;
        gap: 10px;
        margin-top: 15px;
    }
    
    .action-btn {
        padding: 8px 16px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s ease;
    }
    
    .clear-btn {
        background: #dc3545;
        color: white;
    }
    
    .clear-btn:hover {
        background: #c82333;
    }
    
    .toggle-drawing-btn {
        background: #28a745;
        color: white;
    }
    
    .toggle-drawing-btn:hover {
        background: #218838;
    }
    
    .toggle-drawing-btn.active {
        background: #ffc107;
        color: #212529;
    }
    
    /* Draggable Elements Styles */
    .draggable-element {
        position: absolute;
        cursor: move;
        border: 2px dashed transparent;
        transition: all 0.3s ease;
        z-index: 5;
    }
    
    .draggable-element:hover {
        border-color: #007bff;
    }
    
    .draggable-element.selected {
        border-color: #007bff;
        box-shadow: 0 0 10px rgba(0, 123, 255, 0.3);
    }
    
    .draggable-element.resizing {
        border-color: #28a745;
    }
    
    .resize-handle {
        position: absolute;
        width: 10px;
        height: 10px;
        background: #007bff;
        border: 2px solid white;
        border-radius: 50%;
        cursor: nw-resize;
    }
    
    .resize-handle.top-left {
        top: -5px;
        left: -5px;
        cursor: nw-resize;
    }
    
    .resize-handle.top-right {
        top: -5px;
        right: -5px;
        cursor: ne-resize;
    }
    
    .resize-handle.bottom-left {
        bottom: -5px;
        left: -5px;
        cursor: sw-resize;
    }
    
    .resize-handle.bottom-right {
        bottom: -5px;
        right: -5px;
        cursor: se-resize;
    }
    
    .text-element {
        font-family: Arial, sans-serif;
        font-weight: bold;
        color: #000;
        background: rgba(255, 255, 255, 0.8);
        padding: 5px 10px;
        border-radius: 5px;
        min-width: 50px;
        text-align: center;
    }
    
    .shape-element {
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 24px;
    }
    
    .drop-zone {
        border: 2px dashed #ccc;
        border-radius: 10px;
        padding: 20px;
        text-align: center;
        color: #666;
        transition: all 0.3s ease;
    }
    
    .drop-zone.drag-over {
        border-color: #007bff;
        background: rgba(0, 123, 255, 0.1);
        color: #007bff;
    }

    </style>
</head>
<body>
    <div class="container mt-5">
        <h1 class="text-center mb-4">Design your Jersey!</h1>
        <a href="/customer-home" class="exit-button">Exit</a>
        <div class="apparel-type-toggle">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-primary" id="jerseyToggle">Jersey</button>
                <button type="button" class="btn btn-outline-primary" id="shortsToggle">Shorts</button>
            </div>
        </div>
        
        <div class="row">
            <div class="col-lg-8">
                <div class="apparel-viewport">
                    <div class="apparel-container" id="apparelContainer">
                        <!-- Jersey Front -->
                        <div class="apparel-side apparel-front" id="jerseyFront">
                            <svg class="apparel-svg" id="frontJerseySvg" viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                                <!-- Fabric Texture Patterns -->
                                <defs>
                                    <pattern id="meshPattern" patternUnits="userSpaceOnUse" width="4" height="4">
                                        <rect width="4" height="4" fill="rgba(255,255,255,0.1)"/>
                                        <circle cx="2" cy="2" r="0.8" fill="rgba(0,0,0,0.1)"/>
                                    </pattern>
                                    <pattern id="cottonPattern" patternUnits="userSpaceOnUse" width="6" height="6">
                                        <rect width="6" height="6" fill="rgba(255,255,255,0.05)"/>
                                        <path d="M0,3 L3,0 M3,6 L6,3" stroke="rgba(0,0,0,0.08)" stroke-width="0.5"/>
                                        <path d="M0,3 L3,6 M3,0 L6,3" stroke="rgba(0,0,0,0.08)" stroke-width="0.5"/>
                                    </pattern>
                                    <pattern id="polyesterPattern" patternUnits="userSpaceOnUse" width="3" height="3">
                                        <rect width="3" height="3" fill="rgba(255,255,255,0.08)"/>
                                        <rect x="0" y="0" width="1.5" height="1.5" fill="rgba(0,0,0,0.05)"/>
                                        <rect x="1.5" y="1.5" width="1.5" height="1.5" fill="rgba(0,0,0,0.05)"/>
                                    </pattern>
                                    
                                    <!-- AI Pattern Definitions -->
                                    <pattern id="stripesPattern" patternUnits="userSpaceOnUse" width="20" height="20" patternTransform="rotate(45)">
                                        <rect width="20" height="20" fill="currentColor"/>
                                        <rect x="0" y="0" width="10" height="20" fill="white" opacity="0.3"/>
                                    </pattern>
                                    
                                    <pattern id="dotsPattern" patternUnits="userSpaceOnUse" width="15" height="15">
                                        <rect width="15" height="15" fill="currentColor"/>
                                        <circle cx="7.5" cy="7.5" r="3" fill="white" opacity="0.4"/>
                                        <circle cx="0" cy="0" r="1.5" fill="white" opacity="0.3"/>
                                        <circle cx="15" cy="15" r="1.5" fill="white" opacity="0.3"/>
                                    </pattern>
                                    
                                    <pattern id="geometricPattern" patternUnits="userSpaceOnUse" width="16" height="16">
                                        <rect width="16" height="16" fill="currentColor"/>
                                        <polygon points="0,0 8,0 8,8" fill="white" opacity="0.3"/>
                                        <polygon points="8,8 16,8 16,16 8,16" fill="white" opacity="0.2"/>
                                        <polygon points="0,8 8,16 0,16" fill="white" opacity="0.4"/>
                                    </pattern>
                                    
                                    <!-- Lighting Effect Gradients -->
                                    <linearGradient id="naturalLight" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.3);stop-opacity:1" />
                                        <stop offset="50%" style="stop-color:rgba(255,255,255,0.1);stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:rgba(0,0,0,0.1);stop-opacity:1" />
                                    </linearGradient>
                                    
                                    <linearGradient id="studioLight" x1="0%" y1="0%" x2="100%" y2="50%">
                                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.4);stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:rgba(0,0,0,0.05);stop-opacity:1" />
                                    </linearGradient>
                                    
                                    <linearGradient id="dramaticLight" x1="20%" y1="20%" x2="80%" y2="80%">
                                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.5);stop-opacity:1" />
                                        <stop offset="40%" style="stop-color:rgba(128,128,128,0.2);stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:rgba(0,0,0,0.3);stop-opacity:1" />
                                    </linearGradient>
                                    
                                    <linearGradient id="softLight" x1="0%" y1="0%" x2="100%" y2="100%">
                                        <stop offset="0%" style="stop-color:rgba(255,255,255,0.2);stop-opacity:1" />
                                        <stop offset="100%" style="stop-color:rgba(240,240,240,0.1);stop-opacity:1" />
                                    </linearGradient>
                                    
                                    <!-- Shadow Effects -->
                                    <filter id="dropShadow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feDropShadow dx="2" dy="4" stdDeviation="3" flood-opacity="0.3"/>
                                    </filter>
                                    
                                    <filter id="innerShadow" x="-50%" y="-50%" width="200%" height="200%">
                                        <feOffset dx="0" dy="0"/>
                                        <feGaussianBlur stdDeviation="2" result="offset-blur"/>
                                        <feFlood flood-color="#000000" flood-opacity="0.2"/>
                                        <feComposite in2="offset-blur" operator="in"/>
                                    </filter>
                                </defs>
                                <!-- Jersey Body -->
                                <path class="jersey-body" d="M75,50 C75,50 100,20 150,20 C200,20 225,50 225,50 
                                    L225,350 C225,350 200,370 150,370 C100,370 75,350 75,350 Z" 
                                    fill="#ffffff" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Collar -->
                                <path class="jersey-collar" d="M125,50 L175,50 C175,50 170,30 150,30 C130,30 125,50 125,50 Z 
                                    M140,50 L160,50 L160,70 C160,75 150,75 150,70 C150,75 140,75 140,70 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Left Sleeve -->
                                <path class="jersey-sleeve" d="M75,50 C75,50 60,60 40,80 L20,100 L30,140 L75,120 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Right Sleeve -->
                                <path class="jersey-sleeve" d="M225,50 C225,50 240,60 260,80 L280,100 L270,140 L225,120 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Seams and Details -->
                                <path class="jersey-seam" d="M150,50 L150,350" stroke="#000000" stroke-width="0.5" stroke-dasharray="2,2"/>
                                <path class="jersey-seam" d="M100,50 C100,60 100,70 100,80" stroke="#000000" stroke-width="0.5"/>
                                <path class="jersey-seam" d="M200,50 C200,60 200,70 200,80" stroke="#000000" stroke-width="0.5"/>
                                
                                <!-- Sleeve Cuffs -->
                                <path class="jersey-cuff" d="M30,140 L75,120" stroke="#000000" stroke-width="3"/>
                                <path class="jersey-cuff" d="M270,140 L225,120" stroke="#000000" stroke-width="3"/>
                                
                                <!-- Bottom Hem -->
                                <path class="jersey-hem" d="M75,350 C75,350 100,370 150,370 C200,370 225,350 225,350" 
                                    stroke="#000000" stroke-width="3" fill="none"/>
                                
                                <!-- Number Placeholder -->
                                <text id="frontNumberText" x="150" y="200" font-family="Arial" font-size="80" text-anchor="middle" fill="#000000"></text>
                            </svg>
                            <div class="logo-overlay" id="frontJerseyLogoOverlay">
                                <img class="logo-image" id="frontJerseyLogoImage" style="display: none;">
                            </div>
                        </div>
                        
                        <!-- Jersey Back -->
                        <div class="apparel-side apparel-back" id="jerseyBack">
                            <svg class="apparel-svg" id="backJerseySvg" viewBox="0 0 300 400" xmlns="http://www.w3.org/2000/svg">
                                <!-- Jersey Body -->
                                <path class="jersey-body" d="M75,50 C75,50 100,20 150,20 C200,20 225,50 225,50 
                                    L225,350 C225,350 200,370 150,370 C100,370 75,350 75,350 Z" 
                                    fill="#ffffff" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Collar -->
                                <path class="jersey-collar" d="M125,50 L175,50 C175,50 170,30 150,30 C130,30 125,50 125,50 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Left Sleeve -->
                                <path class="jersey-sleeve" d="M75,50 C75,50 60,60 40,80 L20,100 L30,140 L75,120 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Right Sleeve -->
                                <path class="jersey-sleeve" d="M225,50 C225,50 240,60 260,80 L280,100 L270,140 L225,120 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Seams and Details -->
                                <path class="jersey-seam" d="M150,50 L150,350" stroke="#000000" stroke-width="0.5" stroke-dasharray="2,2"/>
                                <path class="jersey-seam" d="M100,50 C100,60 100,70 100,80" stroke="#000000" stroke-width="0.5"/>
                                <path class="jersey-seam" d="M200,50 C200,60 200,70 200,80" stroke="#000000" stroke-width="0.5"/>
                                
                                <!-- Sleeve Cuffs -->
                                <path class="jersey-cuff" d="M30,140 L75,120" stroke="#000000" stroke-width="3"/>
                                <path class="jersey-cuff" d="M270,140 L225,120" stroke="#000000" stroke-width="3"/>
                                
                                <!-- Bottom Hem -->
                                <path class="jersey-hem" d="M75,350 C75,350 100,370 150,370 C200,370 225,350 225,350" 
                                    stroke="#000000" stroke-width="3" fill="none"/>
                                
                                <!-- Name Placeholder -->
                                <text id="backNameText" x="150" y="100" font-family="Arial" font-size="24" text-anchor="middle" fill="#000000"></text>
                                
                                <!-- Number Placeholder -->
                                <text id="backNumberText" x="150" y="200" font-family="Arial" font-size="80" text-anchor="middle" fill="#000000"></text>
                            </svg>
                            <div class="logo-overlay" id="backJerseyLogoOverlay">
                                <img class="logo-image" id="backJerseyLogoImage" style="display: none;">
                            </div>
                        </div>
                        
                        <!-- Shorts Front -->
                        <div class="apparel-side apparel-front" id="shortsFront" style="display: none;">
                            <svg class="apparel-svg" id="frontShortsSvg" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                                <!-- Shorts Waistband -->
                                <path class="shorts-waistband" d="M75,20 L225,20 L225,40 L75,40 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Shorts Body -->
                                <path class="shorts-body" d="M75,40 L225,40 L240,200 L180,200 L150,280 L120,200 L60,200 Z" 
                                    fill="#ffffff" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Center Seam -->
                                <path class="shorts-seam" d="M150,40 L150,280" stroke="#000000" stroke-width="0.5" stroke-dasharray="2,2"/>
                                
                                <!-- Side Seams -->
                                <path class="shorts-seam" d="M75,40 L60,200" stroke="#000000" stroke-width="0.5"/>
                                <path class="shorts-seam" d="M225,40 L240,200" stroke="#000000" stroke-width="0.5"/>
                                
                                <!-- Leg Openings -->
                                <path class="shorts-leg-left" d="M60,200 L120,200" stroke="#000000" stroke-width="3"/>
                                <path class="shorts-leg-right" d="M180,200 L240,200" stroke="#000000" stroke-width="3"/>
                                
                                <!-- Leg Extensions -->
                                <path class="shorts-leg-extension-left" d="M120,200 L150,280" stroke="#000000" stroke-width="2" fill="none"/>
                                <path class="shorts-leg-extension-right" d="M180,200 L150,280" stroke="#000000" stroke-width="2" fill="none"/>
                                
                                <!-- Pocket Outlines (Optional) -->
                                <path class="shorts-pocket-left" d="M90,80 C90,80 100,70 110,80 C120,90 120,110 110,120 C100,130 90,120 90,110 Z" 
                                    stroke="#000000" stroke-width="0.5" fill="none" stroke-dasharray="3,2"/>
                                <path class="shorts-pocket-right" d="M210,80 C210,80 200,70 190,80 C180,90 180,110 190,120 C200,130 210,120 210,110 Z" 
                                    stroke="#000000" stroke-width="0.5" fill="none" stroke-dasharray="3,2"/>
                                
                                <!-- Number Placeholder -->
                                <text id="frontShortsNumberText" x="150" y="120" font-family="Arial" font-size="40" text-anchor="middle" fill="#000000"></text>
                            </svg>
                            <div class="logo-overlay" id="frontShortsLogoOverlay">
                                <img class="logo-image" id="frontShortsLogoImage" style="display: none;">
                            </div>
                        </div>
                        
                        <!-- Shorts Back -->
                        <div class="apparel-side apparel-back" id="shortsBack" style="display: none;">
                            <svg class="apparel-svg" id="backShortsSvg" viewBox="0 0 300 300" xmlns="http://www.w3.org/2000/svg">
                                <!-- Shorts Waistband -->
                                <path class="shorts-waistband" d="M75,20 L225,20 L225,40 L75,40 Z" 
                                    fill="#dddddd" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Shorts Body -->
                                <path class="shorts-body" d="M75,40 L225,40 L240,200 L180,200 L150,280 L120,200 L60,200 Z" 
                                    fill="#ffffff" stroke="#000000" stroke-width="2"/>
                                
                                <!-- Center Seam -->
                                <path class="shorts-seam" d="M150,40 L150,280" stroke="#000000" stroke-width="0.5" stroke-dasharray="2,2"/>
                                
                                <!-- Side Seams -->
                                <path class="shorts-seam" d="M75,40 L60,200" stroke="#000000" stroke-width="0.5"/>
                                <path class="shorts-seam" d="M225,40 L240,200" stroke="#000000" stroke-width="0.5"/>
                                
                                <!-- Leg Openings -->
                                <path class="shorts-leg-left" d="M60,200 L120,200" stroke="#000000" stroke-width="3"/>
                                <path class="shorts-leg-right" d="M180,200 L240,200" stroke="#000000" stroke-width="3"/>
                                
                                <!-- Leg Extensions -->
                                <path class="shorts-leg-extension-left" d="M120,200 L150,280" stroke="#000000" stroke-width="2" fill="none"/>
                                <path class="shorts-leg-extension-right" d="M180,200 L150,280" stroke="#000000" stroke-width="2" fill="none"/>
                                
                                <!-- Number Placeholder -->
                                <text id="backShortsNumberText" x="150" y="120" font-family="Arial" font-size="40" text-anchor="middle" fill="#000000"></text>
                            </svg>
                            <div class="logo-overlay" id="backShortsLogoOverlay">
                                <img class="logo-image" id="backShortsLogoImage" style="display: none;">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="rotation-controls">
                        <button class="btn btn-outline-primary" id="showFrontBtn">Front</button>
                        <button class="btn btn-outline-primary" id="showBackBtn">Back</button>
                    </div>
                    <input type="range" class="form-range rotation-slider" id="rotationSlider" min="0" max="180" value="0">
                    
                    <!-- Logo Size Controls -->
                    <div class="logo-controls" id="logoControls">
                        <div class="size-label">
                            <span>Logo Size:</span>
                            <span class="logo-size-value">100%</span>
                        </div>
                        <input type="range" class="form-range" id="logoSizeSlider" min="20" max="200" value="100">
                    </div>
                </div>
            </div>
            
            <div class="col-lg-4">
                <div class="card">
                    <div class="card-header">
                        <h5>Customize Your <span id="apparelTypeText">Jersey</span></h5>
                    </div>
                    <div class="card-body">
                        <!-- Enhanced AI Design Generator -->
                        <div class="mb-4">
                            <h5 class="form-label">🤖 Enhanced AI Design Generator</h5>
                            <div class="card border-primary">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label">Describe your innovative design</label>
                                        <textarea class="form-control" id="aiPrompt" rows="4" placeholder="Example: Create a cosmic nebula design with fractal patterns, holographic colors, and photo-realistic textures. Use quantum field energy effects with neural network patterns."></textarea>
                                        <div class="form-text">✨ <strong>New Features:</strong> Photo integration, fractal patterns, creative color mixing, advanced textures, and innovative visual effects!</div>
                                    </div>
                                    

                                    <!-- Quick Style Presets -->
                                    <div class="mb-3">
                                        <label class="form-label">🚀 Quick Style Presets</label>
                                        <div class="btn-group-vertical w-100" role="group">
                                            <button type="button" class="btn btn-outline-info btn-sm preset-btn" data-preset="cosmic">🌌 Cosmic Nebula</button>
                                            <button type="button" class="btn btn-outline-success btn-sm preset-btn" data-preset="nature">🌿 Nature Fusion</button>
                                            <button type="button" class="btn btn-outline-warning btn-sm preset-btn" data-preset="cyber">⚡ Cyber Matrix</button>
                                            <button type="button" class="btn btn-outline-danger btn-sm preset-btn" data-preset="volcanic">🌋 Volcanic Fire</button>
                                        </div>
                                    </div>
                                    
                                    <div class="d-grid gap-2">
                                        <button class="btn btn-success btn-lg" id="generateAiDesignBtn">
                                            <span class="spinner-border spinner-border-sm me-2" id="aiLoadingSpinner" style="display: none;"></span>
                                            🎨 Generate Innovative Design
                                        </button>
                                        <div class="btn-group" role="group">
                                            <button class="btn btn-outline-secondary btn-sm" id="randomizePromptBtn">🎲 Random Idea</button>
                                            <button class="btn btn-outline-primary btn-sm" id="surpriseMeBtn">✨ Surprise Me!</button>
                                        </div>
                                    </div>
                                    
                                    <!-- AI Knowledge Base Info -->
                                    <div class="mt-3">
                                        <small class="text-muted">
                                            <strong>💡 Pro Tips:</strong> Try keywords like "fractal", "holographic", "quantum", "neural", "cosmic", "volcanic", "crystalline", or "photo-realistic" for amazing results!
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                        

                        
                        <!-- Drag & Drop Elements Panel -->
                        <div class="drawing-tools">
                            <h5>🎯 Design Elements</h5>
                            
                            <div class="mb-3">
                                <label class="form-label">Upload Images</label>
                                <input type="file" class="form-control" id="imageUpload" accept="image/*" multiple>
                                <div class="form-text">Upload logos, graphics, or design elements</div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Add Text Element</label>
                                <div class="d-flex gap-2">
                                    <input type="text" class="form-control" id="textInput" placeholder="Enter text">
                                    <button class="btn btn-primary" id="addTextBtn">Add</button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Quick Shapes</label>
                                <div class="tool-group">
                                    <button class="tool-btn" data-shape="circle">⭕ Circle</button>
                                    <button class="tool-btn" data-shape="square">⬜ Square</button>
                                    <button class="tool-btn" data-shape="triangle">🔺 Triangle</button>
                                    <button class="tool-btn" data-shape="star">⭐ Star</button>
                                    <button class="tool-btn" data-shape="line">📏 Line</button>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Shape Color</label>
                                <div class="d-flex gap-2 align-items-center">
                                    <input type="color" class="form-control form-control-color" id="shapeColor" value="#007bff" title="Choose shape color">
                                    <button class="btn btn-sm btn-outline-primary" id="applyShapeColor">Apply to Selected</button>
                                </div>
                            </div>
                            
                            <div class="drawing-actions">
                                <button class="action-btn clear-btn" id="clearElements">Clear All Elements</button>
                            </div>
                        </div>
                        
                        <!-- Layer Management Panel -->
                        <div class="control-section">
                            <h5>Layer Management</h5>
                            <div class="layer-panel">
                                <div class="layer-controls">
                                    <button id="moveLayerUp" class="btn btn-sm btn-outline-primary" title="Move Layer Up">↑</button>
                                    <button id="moveLayerDown" class="btn btn-sm btn-outline-primary" title="Move Layer Down">↓</button>
                                    <button id="duplicateLayer" class="btn btn-sm btn-outline-success" title="Duplicate Layer">📋</button>
                                    <button id="deleteLayer" class="btn btn-sm btn-outline-danger" title="Delete Layer">🗑️</button>
                                </div>
                                <div id="layerList" class="layer-list">
                                    <!-- Layers will be dynamically added here -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Color Type</label>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="colorType" id="solidColorRadio" checked>
                                <label class="form-check-label" for="solidColorRadio">
                                    Solid Color
                                </label>
                            </div>
                            <div class="form-check">
                                <input class="form-check-input" type="radio" name="colorType" id="gradientColorRadio">
                                <label class="form-check-label" for="gradientColorRadio">
                                    Gradient Color
                                </label>
                            </div>
                        </div>
                        
                        <!-- Solid Color Options -->
                        <div id="solidColorOptions">
                            <div class="mb-3">
                                <label class="form-label">Main Color</label>
                                <div class="d-flex flex-wrap">
                                    <div class="color-swatch active" style="background-color: #ffffff;" data-color="#ffffff" data-target="main"></div>
                                    <div class="color-swatch" style="background-color: #ff0000;" data-color="#ff0000" data-target="main"></div>
                                    <div class="color-swatch" style="background-color: #0000ff;" data-color="#0000ff" data-target="main"></div>
                                    <div class="color-swatch" style="background-color: #00ff00;" data-color="#00ff00" data-target="main"></div>
                                    <div class="color-swatch" style="background-color: #ffff00;" data-color="#ffff00" data-target="main"></div>
                                    <div class="color-swatch" style="background-color: #000000;" data-color="#000000" data-target="main"></div>
                                </div>
                                <input type="color" class="form-control form-control-color mt-2" id="mainColor" value="#ffffff">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Secondary Color</label>
                                <div class="d-flex flex-wrap">
                                    <div class="color-swatch" style="background-color: #ffffff;" data-color="#ffffff" data-target="secondary"></div>
                                    <div class="color-swatch" style="background-color: #ff0000;" data-color="#ff0000" data-target="secondary"></div>
                                    <div class="color-swatch" style="background-color: #0000ff;" data-color="#0000ff" data-target="secondary"></div>
                                    <div class="color-swatch" style="background-color: #00ff00;" data-color="#00ff00" data-target="secondary"></div>
                                    <div class="color-swatch" style="background-color: #ffff00;" data-color="#ffff00" data-target="secondary"></div>
                                    <div class="color-swatch active" style="background-color: #dddddd;" data-color="#dddddd" data-target="secondary"></div>
                                </div>
                                <input type="color" class="form-control form-control-color mt-2" id="secondaryColor" value="#dddddd">
                            </div>
                        </div>
                        
                        <!-- Gradient Color Options -->
                        <div id="gradientColorOptions" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Gradient Preview</label>
                                <div class="gradient-preview" id="gradientPreview"></div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Gradient Presets</label>
                                <div class="d-flex flex-wrap">
                                    <div class="gradient-swatch" style="background-image: linear-gradient(to right, #ff0000, #0000ff);" data-colors="#ff0000,#0000ff"></div>
                                    <div class="gradient-swatch" style="background-image: linear-gradient(to right, #00ff00, #ffff00);" data-colors="#00ff00,#ffff00"></div>
                                    <div class="gradient-swatch" style="background-image: linear-gradient(to right, #000000, #ffffff);" data-colors="#000000,#ffffff"></div>
                                    <div class="gradient-swatch" style="background-image: linear-gradient(to right, #ff00ff, #00ffff);" data-colors="#ff00ff,#00ffff"></div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Start Color</label>
                                <input type="color" class="form-control form-control-color w-100" id="gradientStartColor" value="#ff0000">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">End Color</label>
                                <input type="color" class="form-control form-control-color w-100" id="gradientEndColor" value="#0000ff">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label">Gradient Direction</label>
                                <select class="form-select" id="gradientDirection">
                                    <option value="to right">Horizontal</option>
                                    <option value="to bottom">Vertical</option>
                                    <option value="to bottom right">Diagonal</option>
                                    <option value="circle at center">Radial</option>
                                </select>
                            </div>
                        </div>
                        

                        

                        

                        

                        

                        
                        <div class="mb-3">
                            <label class="form-label">Player Name</label>
                            <input type="text" class="form-control" id="playerName" placeholder="Enter name" maxlength="15">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Player Number</label>
                            <input type="number" class="form-control" id="playerNumber" placeholder="Enter number" min="0" max="99">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Text Color</label>
                            <div class="d-flex flex-wrap">
                                <div class="color-swatch" style="background-color: #ffffff;" data-color="#ffffff" data-target="text"></div>
                                <div class="color-swatch" style="background-color: #ff0000;" data-color="#ff0000" data-target="text"></div>
                                <div class="color-swatch" style="background-color: #0000ff;" data-color="#0000ff" data-target="text"></div>
                                <div class="color-swatch" style="background-color: #ffff00;" data-color="#ffff00" data-target="text"></div>
                                <div class="color-swatch active" style="background-color: #000000;" data-color="#000000" data-target="text"></div>
                            </div>
                            <input type="color" class="form-control form-control-color mt-2" id="textColor" value="#000000">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">Team Logo</label>
                            <input type="file" class="form-control" id="logoUpload" accept="image/*">
                            <div class="form-text mt-1">Upload a logo, then drag to position and adjust size.</div>
                        </div>
                        

                        
                        <div class="mb-3">
                            <button class="btn btn-primary w-100" id="saveDesignBtn">Save Design</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Elements
            const apparelContainer = document.getElementById('apparelContainer');
            const showFrontBtn = document.getElementById('showFrontBtn');
            const showBackBtn = document.getElementById('showBackBtn');
            const rotationSlider = document.getElementById('rotationSlider');
            const mainColor = document.getElementById('mainColor');
            const secondaryColor = document.getElementById('secondaryColor');
            const playerName = document.getElementById('playerName');
            const playerNumber = document.getElementById('playerNumber');
            const textColor = document.getElementById('textColor');
            const logoUpload = document.getElementById('logoUpload');
            const saveDesignBtn = document.getElementById('saveDesignBtn');
            const apparelTypeText = document.getElementById('apparelTypeText');
            
            // Apparel type toggle
            const jerseyToggle = document.getElementById('jerseyToggle');
            const shortsToggle = document.getElementById('shortsToggle');
            
            // Jersey elements
            const jerseyFront = document.getElementById('jerseyFront');
            const jerseyBack = document.getElementById('jerseyBack');
            const frontJerseyLogoImage = document.getElementById('frontJerseyLogoImage');
            const backJerseyLogoImage = document.getElementById('backJerseyLogoImage');
            
            // Shorts elements
            const shortsFront = document.getElementById('shortsFront');
            const shortsBack = document.getElementById('shortsBack');
            const frontShortsLogoImage = document.getElementById('frontShortsLogoImage');
            const backShortsLogoImage = document.getElementById('backShortsLogoImage');
            
            // Color type toggle
            const solidColorRadio = document.getElementById('solidColorRadio');
            const gradientColorRadio = document.getElementById('gradientColorRadio');
            const solidColorOptions = document.getElementById('solidColorOptions');
            const gradientColorOptions = document.getElementById('gradientColorOptions');
            
            // Gradient elements
            const gradientPreview = document.getElementById('gradientPreview');
            const gradientStartColor = document.getElementById('gradientStartColor');
            const gradientEndColor = document.getElementById('gradientEndColor');
            const gradientDirection = document.getElementById('gradientDirection');
            const gradientSwatches = document.querySelectorAll('.gradient-swatch');
            
            // Logo size controls
            const logoControls = document.getElementById('logoControls');
            const logoSizeSlider = document.getElementById('logoSizeSlider');
            // logoSizeValue already declared above
            
            // SVG elements
            const frontNumberText = document.getElementById('frontNumberText');
            const backNameText = document.getElementById('backNameText');
            const backNumberText = document.getElementById('backNumberText');
            const frontShortsNumberText = document.getElementById('frontShortsNumberText');
            const backShortsNumberText = document.getElementById('backShortsNumberText');
            
            // Jersey SVG elements
            const jerseyBodies = document.querySelectorAll('.jersey-body');
            const jerseySleeveElements = document.querySelectorAll('.jersey-sleeve');
            const jerseyCollarElements = document.querySelectorAll('.jersey-collar');
            
            // Shorts SVG elements
            const shortsBodyElements = document.querySelectorAll('.shorts-body');
            const shortsWaistbandElements = document.querySelectorAll('.shorts-waistband');
            
            // Color swatches
            const colorSwatches = document.querySelectorAll('.color-swatch');
            
            // State
            let currentApparelType = 'jersey';
            let logoSize = 100; // percentage
            let isGradient = false;
            
            // Event listeners
            showFrontBtn.addEventListener('click', () => {
                rotationSlider.value = 0;
                updateRotation();
            });
            
            showBackBtn.addEventListener('click', () => {
                rotationSlider.value = 180;
                updateRotation();
            });
            
            rotationSlider.addEventListener('input', updateRotation);
            
            mainColor.addEventListener('input', () => {
                updateColors();
                updateColorSwatchActive('main', mainColor.value);
            });
            
            secondaryColor.addEventListener('input', () => {
                updateColors();
                updateColorSwatchActive('secondary', secondaryColor.value);
            });
            
            textColor.addEventListener('input', () => {
                updateTextColor(textColor.value);
                updateColorSwatchActive('text', textColor.value);
            });
            
            playerName.addEventListener('input', updatePlayerName);
            playerNumber.addEventListener('input', updatePlayerNumber);
            
            logoUpload.addEventListener('change', handleLogoUpload);
            
            logoSizeSlider.addEventListener('input', function() {
                logoSize = this.value;
                logoSizeValue.textContent = `${logoSize}%`;
                updateLogoSize();
            });
            
            saveDesignBtn.addEventListener('click', saveDesign);
            
            // Apparel type toggle
            jerseyToggle.addEventListener('click', () => {
                setApparelType('jersey');
            });
            
            shortsToggle.addEventListener('click', () => {
                setApparelType('shorts');
            });
            
            // Color type toggle
            solidColorRadio.addEventListener('change', () => {
                isGradient = false;
                solidColorOptions.style.display = 'block';
                gradientColorOptions.style.display = 'none';
                updateColors();
            });
            
            gradientColorRadio.addEventListener('change', () => {
                isGradient = true;
                solidColorOptions.style.display = 'none';
                gradientColorOptions.style.display = 'block';
                updateGradientPreview();
                updateColors();
            });
            
            // Gradient controls
            gradientStartColor.addEventListener('input', () => {
                updateGradientPreview();
                updateColors();
            });
            
            gradientEndColor.addEventListener('input', () => {
                updateGradientPreview();
                updateColors();
            });
            
            gradientDirection.addEventListener('change', () => {
                updateGradientPreview();
                updateColors();
            });
            
            // Gradient swatches
            gradientSwatches.forEach(swatch => {
                swatch.addEventListener('click', function() {
                    const colors = this.dataset.colors.split(',');
                    gradientStartColor.value = colors[0];
                    gradientEndColor.value = colors[1];
                    updateGradientPreview();
                    updateColors();
                    
                    // Update active state
                    gradientSwatches.forEach(s => s.classList.remove('active'));
                    this.classList.add('active');
                });
            });
            
            // Color swatch clicks
            colorSwatches.forEach(swatch => {
                swatch.addEventListener('click', function() {
                    const target = this.dataset.target;
                    const color = this.dataset.color;
                    
                    // Update active state
                    document.querySelectorAll(`.color-swatch[data-target="${target}"]`).forEach(s => {
                        s.classList.remove('active');
                    });
                    this.classList.add('active');
                    
                    // Update colors
                    if (target === 'main') {
                        mainColor.value = color;
                        updateColors();
                    } else if (target === 'secondary') {
                        secondaryColor.value = color;
                        updateColors();
                    } else if (target === 'text') {
                        textColor.value = color;
                        updateTextColor(color);
                    }
                });
            });
            
            // Functions
            function adjustElementsForApparelType(type) {
                const elements = document.querySelectorAll('.draggable-element');
                elements.forEach(element => {
                    const currentTop = parseInt(element.style.top) || 0;
                    const currentLeft = parseInt(element.style.left) || 0;
                    
                    if (type === 'shorts') {
                        // Adjust positioning for shorts (shorter height, different proportions)
                        // Scale down vertical position and adjust for shorts dimensions
                        const scaledTop = Math.max(50, currentTop * 0.6 + 100); // Scale and offset for shorts
                        element.style.top = scaledTop + 'px';
                        
                        // Ensure elements stay within shorts bounds
                        if (scaledTop > 250) {
                            element.style.top = '250px';
                        }
                    } else {
                        // Restore original positioning for jersey
                        // If element was adjusted for shorts, restore it
                        if (currentTop <= 250) {
                            const restoredTop = Math.max(50, (currentTop - 100) / 0.6);
                            element.style.top = restoredTop + 'px';
                        }
                    }
                });
            }
            
            function setApparelType(type) {
                currentApparelType = type;
                apparelTypeText.textContent = type.charAt(0).toUpperCase() + type.slice(1);
                
                if (type === 'jersey') {
                    jerseyToggle.classList.add('btn-primary');
                    jerseyToggle.classList.remove('btn-outline-primary');
                    shortsToggle.classList.add('btn-outline-primary');
                    shortsToggle.classList.remove('btn-primary');
                    
                    jerseyFront.style.display = '';
                    jerseyBack.style.display = '';
                    shortsFront.style.display = 'none';
                    shortsBack.style.display = 'none';
                } else {
                    shortsToggle.classList.add('btn-primary');
                    shortsToggle.classList.remove('btn-outline-primary');
                    jerseyToggle.classList.add('btn-outline-primary');
                    jerseyToggle.classList.remove('btn-primary');
                    
                    jerseyFront.style.display = 'none';
                    jerseyBack.style.display = 'none';
                    shortsFront.style.display = '';
                    shortsBack.style.display = '';
                }
                
                // Reset rotation
                rotationSlider.value = 0;
                updateRotation();
                
                // Update colors
                updateColors();
                
                // Adjust draggable elements positioning for different apparel types
                adjustElementsForApparelType(type);
            }
            
            function updateRotation() {
                const rotation = rotationSlider.value;
                apparelContainer.style.transform = `rotateY(${rotation}deg)`;
                
                // Update button active states
                if (rotation < 90) {
                    showFrontBtn.classList.add('btn-primary');
                    showFrontBtn.classList.remove('btn-outline-primary');
                    showBackBtn.classList.add('btn-outline-primary');
                    showBackBtn.classList.remove('btn-primary');
                } else {
                    showBackBtn.classList.add('btn-primary');
                    showBackBtn.classList.remove('btn-outline-primary');
                    showFrontBtn.classList.add('btn-outline-primary');
                    showFrontBtn.classList.remove('btn-primary');
                }
            }
            
            function updateColors() {
                if (isGradient) {
                    const gradientString = getGradientString();
                    
                    if (currentApparelType === 'jersey') {
                        jerseyBodies.forEach(body => {
                            body.style.fill = 'url(#gradient)';
                            createGradientDefs(body.closest('svg'), gradientString);
                        });
                        
                        jerseySleeveElements.forEach(sleeve => {
                            sleeve.setAttribute('fill', secondaryColor.value);
                        });
                        
                        jerseyCollarElements.forEach(collar => {
                            collar.setAttribute('fill', secondaryColor.value);
                        });
                    } else {
                        shortsBodyElements.forEach(body => {
                            body.style.fill = 'url(#gradient)';
                            createGradientDefs(body.closest('svg'), gradientString);
                        });
                        
                        shortsWaistbandElements.forEach(waistband => {
                            waistband.setAttribute('fill', secondaryColor.value);
                        });
                    }
                } else {
                    if (currentApparelType === 'jersey') {
                        jerseyBodies.forEach(body => {
                            body.style.fill = '';
                            body.setAttribute('fill', mainColor.value);
                        });
                        
                        jerseySleeveElements.forEach(sleeve => {
                            sleeve.setAttribute('fill', secondaryColor.value);
                        });
                        
                        jerseyCollarElements.forEach(collar => {
                            collar.setAttribute('fill', secondaryColor.value);
                        });
                    } else {
                        shortsBodyElements.forEach(body => {
                            body.style.fill = '';
                            body.setAttribute('fill', mainColor.value);
                        });
                        
                        shortsWaistbandElements.forEach(waistband => {
                            waistband.setAttribute('fill', secondaryColor.value);
                        });
                    }
                }
            }
            
            function createGradientDefs(svg, gradientString) {
                // Remove existing defs
                const existingDefs = svg.querySelector('defs');
                if (existingDefs) {
                    existingDefs.remove();
                }
                
                // Create new defs
                const defs = document.createElementNS('http://www.w3.org/2000/svg', 'defs');
                
                // Create gradient
                let gradient;
                if (gradientDirection.value.includes('circle')) {
                    gradient = document.createElementNS('http://www.w3.org/2000/svg', 'radialGradient');
                    gradient.setAttribute('cx', '0.5');
                    gradient.setAttribute('cy', '0.5');
                    gradient.setAttribute('r', '0.5');
                    gradient.setAttribute('fx', '0.5');
                    gradient.setAttribute('fy', '0.5');
                } else {
                    gradient = document.createElementNS('http://www.w3.org/2000/svg', 'linearGradient');
                    
                    // Set gradient direction
                    if (gradientDirection.value === 'to right') {
                        gradient.setAttribute('x1', '0');
                        gradient.setAttribute('y1', '0.5');
                        gradient.setAttribute('x2', '1');
                        gradient.setAttribute('y2', '0.5');
                    } else if (gradientDirection.value === 'to bottom') {
                        gradient.setAttribute('x1', '0.5');
                        gradient.setAttribute('y1', '0');
                        gradient.setAttribute('x2', '0.5');
                        gradient.setAttribute('y2', '1');
                    } else if (gradientDirection.value === 'to bottom right') {
                        gradient.setAttribute('x1', '0');
                        gradient.setAttribute('y1', '0');
                        gradient.setAttribute('x2', '1');
                        gradient.setAttribute('y2', '1');
                    }
                }
                
                gradient.setAttribute('id', 'gradient');
                
                // Create stops
                const stop1 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop1.setAttribute('offset', '0%');
                stop1.setAttribute('stop-color', gradientStartColor.value);
                
                const stop2 = document.createElementNS('http://www.w3.org/2000/svg', 'stop');
                stop2.setAttribute('offset', '100%');
                stop2.setAttribute('stop-color', gradientEndColor.value);
                
                // Add stops to gradient
                gradient.appendChild(stop1);
                gradient.appendChild(stop2);
                
                // Add gradient to defs
                defs.appendChild(gradient);
                
                // Add defs to SVG
                svg.insertBefore(defs, svg.firstChild);
            }
            
            function getGradientString() {
                if (gradientDirection.value.includes('circle')) {
                    return `radial-gradient(${gradientDirection.value}, ${gradientStartColor.value}, ${gradientEndColor.value})`;
                } else {
                    return `linear-gradient(${gradientDirection.value}, ${gradientStartColor.value}, ${gradientEndColor.value})`;
                }
            }
            
            function updateGradientPreview() {
                gradientPreview.style.backgroundImage = getGradientString();
            }
            
            function updateColorSwatchActive(target, color) {
                // Find if there's a matching swatch
                let matchFound = false;
                document.querySelectorAll(`.color-swatch[data-target="${target}"]`).forEach(swatch => {
                    if (swatch.dataset.color.toLowerCase() === color.toLowerCase()) {
                        swatch.classList.add('active');
                        matchFound = true;
                    } else {
                        swatch.classList.remove('active');
                    }
                });
                
                // If no match found, deactivate all
                if (!matchFound) {
                    document.querySelectorAll(`.color-swatch[data-target="${target}"]`).forEach(swatch => {
                        swatch.classList.remove('active');
                    });
                }
            }
            
            function updatePlayerName() {
                const name = playerName.value.toUpperCase();
                backNameText.textContent = name;
            }
            
            function updatePlayerNumber() {
                const number = playerNumber.value;
                frontNumberText.textContent = number;
                backNumberText.textContent = number;
                frontShortsNumberText.textContent = number;
                backShortsNumberText.textContent = number;
            }
            
            function updateTextColor(color) {
                frontNumberText.setAttribute('fill', color);
                backNameText.setAttribute('fill', color);
                backNumberText.setAttribute('fill', color);
                frontShortsNumberText.setAttribute('fill', color);
                backShortsNumberText.setAttribute('fill', color);
            }
            
            function updateLogoSize() {
                // Calculate actual size based on percentage
                const baseSize = 100; // base size in pixels
                const actualSize = (baseSize * logoSize) / 100;
                
                // Apply to logos
                const activeLogos = getActiveLogos();
                activeLogos.forEach(logo => {
                    logo.style.width = `${actualSize}px`;
                    logo.style.height = 'auto';
                });
            }
            
            function getActiveLogos() {
                if (currentApparelType === 'jersey') {
                    return [frontJerseyLogoImage, backJerseyLogoImage];
                } else {
                    return [frontShortsLogoImage, backShortsLogoImage];
                }
            }
            
            function handleLogoUpload(event) {
                const file = event.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        // Set the logo for current apparel type
                        const activeLogos = getActiveLogos();
                        activeLogos.forEach(logo => {
                            logo.src = e.target.result;
                            logo.style.display = 'block';
                            makeDraggable(logo);
                        });
                        
                        // Reset logo size to 100%
                        logoSize = 100;
                        logoSizeSlider.value = 100;
                        logoSizeValue.textContent = '100%';
                        updateLogoSize();
                        
                        // Show logo controls
                        logoControls.style.display = 'block';
                    };
                    reader.readAsDataURL(file);
                }
            }
            
            function makeDraggable(element) {
                let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                element.onmousedown = dragMouseDown;
                
                function dragMouseDown(e) {
                    e.preventDefault();
                    // Get the mouse cursor position at startup
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // Call a function whenever the cursor moves
                    document.onmousemove = elementDrag;
                }
                
                function elementDrag(e) {
                    e.preventDefault();
                    // Calculate the new cursor position
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    
                    // Set the element's new position
                    const newTop = (element.offsetTop - pos2);
                    const newLeft = (element.offsetLeft - pos1);
                    
                    // Keep the logo within the apparel boundaries
                    const parent = element.parentElement.parentElement;
                    const maxTop = parent.offsetHeight - element.offsetHeight;
                    const maxLeft = parent.offsetWidth - element.offsetWidth;
                    
                    element.style.top = Math.max(0, Math.min(newTop, maxTop)) + "px";
                    element.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + "px";
                    
                    // Remove the transform that centers the logo
                    element.style.transform = 'none';
                }
                
                function closeDragElement() {
                    // Stop moving when mouse button is released
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
                
                // Add touch support for mobile devices
                element.ontouchstart = function(e) {
                    const touch = e.touches[0];
                    pos3 = touch.clientX;
                    pos4 = touch.clientY;
                    
                    document.ontouchend = function() {
                        document.ontouchend = null;
                        document.ontouchmove = null;
                    };
                    
                    document.ontouchmove = function(e) {
                        const touch = e.touches[0];
                        pos1 = pos3 - touch.clientX;
                        pos2 = pos4 - touch.clientY;
                        pos3 = touch.clientX;
                        pos4 = touch.clientY;
                        
                        const newTop = (element.offsetTop - pos2);
                        const newLeft = (element.offsetLeft - pos1);
                        
                        const parent = element.parentElement.parentElement;
                        const maxTop = parent.offsetHeight - element.offsetHeight;
                        const maxLeft = parent.offsetWidth - element.offsetWidth;
                        
                        element.style.top = Math.max(0, Math.min(newTop, maxTop)) + "px";
                        element.style.left = Math.max(0, Math.min(newLeft, maxLeft)) + "px";
                        element.style.transform = 'none';
                    };
                };
            }
            
            function saveDesign() {
                // Create a canvas element
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                
                // Set canvas dimensions
                canvas.width = 800;
                canvas.height = 800;
                
                // Draw background
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Get the current SVG
                let currentSVG;
                let currentLogo;
                
                if (currentApparelType === 'jersey') {
                    currentSVG = rotationSlider.value < 90 ? 
                        document.getElementById('frontJerseySvg') : 
                        document.getElementById('backJerseySvg');
                    
                    currentLogo = rotationSlider.value < 90 ? 
                        frontJerseyLogoImage : 
                        backJerseyLogoImage;
                } else {
                    currentSVG = rotationSlider.value < 90 ? 
                        document.getElementById('frontShortsSvg') : 
                        document.getElementById('backShortsSvg');
                    
                    currentLogo = rotationSlider.value < 90 ? 
                        frontShortsLogoImage : 
                        backShortsLogoImage;
                }
                
                // Convert SVG to string
                const svgData = new XMLSerializer().serializeToString(currentSVG);
                const svgBlob = new Blob([svgData], {type: 'image/svg+xml;charset=utf-8'});
                const svgUrl = URL.createObjectURL(svgBlob);
                
                // Create an image from the SVG
                const img = new Image();
                img.onload = function() {
                    // Draw the SVG
                    ctx.drawImage(img, 150, 100, 500, 600);
                    
                    // Draw logo if present
                    if (currentLogo.style.display !== 'none') {
                        // Calculate logo position relative to the canvas
                        const logoRect = currentLogo.getBoundingClientRect();
                        const svgRect = currentSVG.getBoundingClientRect();
                        
                        // Calculate relative position
                        const relX = (logoRect.left - svgRect.left) / svgRect.width;
                        const relY = (logoRect.top - svgRect.top) / svgRect.height;
                        
                        // Apply to canvas
                        const canvasX = 150 + (relX * 500);
                        const canvasY = 100 + (relY * 600);
                        
                        // Calculate size based on the current logo size
                        const logoWidth = currentLogo.offsetWidth;
                        const logoHeight = currentLogo.offsetHeight;
                        
                        ctx.drawImage(currentLogo, canvasX, canvasY, logoWidth, logoHeight);
                    }
                    
                    // Create download link
                    const link = document.createElement('a');
                    link.download = `custom-${currentApparelType}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                };
                img.src = svgUrl;
            }
            
            // AI Color Harmony System
            // Note: Harmony button and presets removed to fix null reference error
            
            // Color theory algorithms
            function hexToHsl(hex) {
                const r = parseInt(hex.slice(1, 3), 16) / 255;
                const g = parseInt(hex.slice(3, 5), 16) / 255;
                const b = parseInt(hex.slice(5, 7), 16) / 255;
                
                const max = Math.max(r, g, b);
                const min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                
                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                
                return [h * 360, s * 100, l * 100];
            }
            
            function hslToHex(h, s, l) {
                h /= 360; s /= 100; l /= 100;
                const c = (1 - Math.abs(2 * l - 1)) * s;
                const x = c * (1 - Math.abs((h * 6) % 2 - 1));
                const m = l - c / 2;
                let r = 0, g = 0, b = 0;
                
                if (0 <= h && h < 1/6) { r = c; g = x; b = 0; }
                else if (1/6 <= h && h < 2/6) { r = x; g = c; b = 0; }
                else if (2/6 <= h && h < 3/6) { r = 0; g = c; b = x; }
                else if (3/6 <= h && h < 4/6) { r = 0; g = x; b = c; }
                else if (4/6 <= h && h < 5/6) { r = x; g = 0; b = c; }
                else if (5/6 <= h && h < 1) { r = c; g = 0; b = x; }
                
                r = Math.round((r + m) * 255);
                g = Math.round((g + m) * 255);
                b = Math.round((b + m) * 255);
                
                return `#${r.toString(16).padStart(2, '0')}${g.toString(16).padStart(2, '0')}${b.toString(16).padStart(2, '0')}`;
            }
            
            function generateColorHarmony(baseColor) {
                const [h, s, l] = hexToHsl(baseColor);
                const harmonies = {
                    complementary: [
                        baseColor,
                        hslToHex((h + 180) % 360, s, l)
                    ],
                    triadic: [
                        baseColor,
                        hslToHex((h + 120) % 360, s, l),
                        hslToHex((h + 240) % 360, s, l)
                    ],
                    analogous: [
                        hslToHex((h - 30 + 360) % 360, s, l),
                        baseColor,
                        hslToHex((h + 30) % 360, s, l)
                    ],
                    splitComplementary: [
                        baseColor,
                        hslToHex((h + 150) % 360, s, l),
                        hslToHex((h + 210) % 360, s, l)
                    ],
                    tetradic: [
                        baseColor,
                        hslToHex((h + 90) % 360, s, l),
                        hslToHex((h + 180) % 360, s, l),
                        hslToHex((h + 270) % 360, s, l)
                    ]
                };
                
                return harmonies;
            }
            
            function createHarmonyPreset(colors, label) {
                const preset = document.createElement('div');
                preset.className = 'harmony-preset';
                preset.setAttribute('data-colors', colors.join(','));
                preset.setAttribute('data-label', label);
                
                colors.forEach(color => {
                    const colorDiv = document.createElement('div');
                    colorDiv.className = 'harmony-color';
                    colorDiv.style.backgroundColor = color;
                    preset.appendChild(colorDiv);
                });
                
                const labelDiv = document.createElement('div');
                labelDiv.className = 'harmony-label';
                labelDiv.textContent = label;
                preset.appendChild(labelDiv);
                
                preset.addEventListener('click', function() {
                    // Remove active class from all presets
                    document.querySelectorAll('.harmony-preset').forEach(p => p.classList.remove('active'));
                    // Add active class to clicked preset
                    this.classList.add('active');
                    
                    // Apply colors to the jersey
                    const presetColors = this.getAttribute('data-colors').split(',');
                    if (presetColors.length >= 2) {
                        mainColor.value = presetColors[0];
                        secondaryColor.value = presetColors[1];
                        updateColor('main', presetColors[0]);
                        updateColor('secondary', presetColors[1]);
                    }
                });
                
                return preset;
            }
            
            // generateAIHarmony function removed due to missing UI elements
            
            // Event listeners for AI harmony
            // Note: Harmony functionality disabled due to missing UI elements
            
            // Fabric Texture System
            const textureOptions = document.querySelectorAll('.texture-option');
            const materialShine = document.getElementById('materialShine'); // May be null
            let currentTexture = 'smooth';
            let currentShineLevel = 20;
            
            function applyFabricTexture(texture, shineLevel) {
                const jerseyElements = document.querySelectorAll('.jersey-body, .jersey-sleeve');
                const shortsElements = document.querySelectorAll('.shorts-body');
                
                // Apply texture filter
                const allElements = [...jerseyElements, ...shortsElements];
                allElements.forEach(element => {
                    // Remove existing texture filters
                    element.style.filter = element.style.filter.replace(/url\(#\w+Pattern\)/g, '');
                    
                    // Apply new texture
                    if (texture !== 'smooth') {
                        const existingFilter = element.style.filter || '';
                        element.style.filter = existingFilter + ` url(#${texture}Pattern)`;
                    }
                    
                    // Apply shine effect
                    const shineOpacity = shineLevel / 100;
                    const shineFilter = `brightness(${1 + shineOpacity * 0.3}) contrast(${1 + shineOpacity * 0.2})`;
                    
                    if (element.style.filter.includes('brightness')) {
                        element.style.filter = element.style.filter.replace(/brightness\([^)]*\)/g, '');
                        element.style.filter = element.style.filter.replace(/contrast\([^)]*\)/g, '');
                    }
                    
                    element.style.filter = (element.style.filter + ' ' + shineFilter).trim();
                });
            }
            
            // Texture option event listeners
            textureOptions.forEach(option => {
                option.addEventListener('click', function() {
                    // Remove active class from all options
                    textureOptions.forEach(opt => opt.classList.remove('active'));
                    // Add active class to clicked option
                    this.classList.add('active');
                    
                    // Get texture type
                    currentTexture = this.getAttribute('data-texture');
                    
                    // Apply texture
                    applyFabricTexture(currentTexture, currentShineLevel);
                });
            });
            
            // Material shine event listener
            if (materialShine) {
                materialShine.addEventListener('input', function() {
                    currentShineLevel = parseInt(this.value);
                    applyFabricTexture(currentTexture, currentShineLevel);
                });
            }
            
            // Initialize fabric texture
            applyFabricTexture(currentTexture, currentShineLevel);
            
            // Enhanced AI Design Generator Functions
            const aiPrompt = document.getElementById('aiPrompt');
            const generateAiDesignBtn = document.getElementById('generateAiDesignBtn');
            const randomizePromptBtn = document.getElementById('randomizePromptBtn');
            const aiLoadingSpinner = document.getElementById('aiLoadingSpinner');
            
            // Enhanced random design prompts with sports templates and team styles
            const randomPrompts = [
                "Create a professional football jersey with navy blue and red colors, classic stripes, and team emblem",
                "Design a college basketball jersey with bold school colors, energetic patterns, and dynamic layout",
                "Make a premier soccer jersey with sophisticated diagonal patterns and elegant color scheme",
                "Generate a major league baseball jersey with traditional pinstripes and classic team colors",
                "Create a professional hockey jersey with aggressive black and red design and sharp patterns",
                "Design a competitive esports jersey with futuristic neon colors and digital patterns",
                "Make an elegant team jersey with refined gold and navy colors and sophisticated patterns",
                "Generate an energetic youth football jersey with vibrant colors and dynamic effects",
                "Create a retro basketball jersey with vintage colors and nostalgic heritage patterns",
                "Design a modern baseball jersey with sleek tech patterns and contemporary layout",
                "Make a streetball jersey with urban graffiti patterns and bold neon colors",
                "Generate a natural outdoor sports jersey with earth tones and organic patterns",
                "Create a futuristic cyberpunk jersey with neon blue and purple gradients, circuit patterns, and a tech logo",
                "Design a vintage sports jersey with classic red and white stripes, retro typography, and team emblem",
                "Make a nature-inspired jersey with forest green base, leaf patterns, and mountain logo in earth tones",
                "Generate an ocean-themed design with wave patterns, blue-to-teal gradient, and anchor symbol",
                "Create a fire-themed jersey with flame patterns, red-orange gradient, and phoenix logo",
                "Design a space-themed jersey with galaxy patterns, dark blue to purple gradient, and rocket logo"
            ];
            
            // Enhanced AI knowledge base for better understanding
            const aiKnowledgeBase = {
                themes: {
                    'futuristic': { colors: ['#00ffff', '#ff00ff', '#0080ff'], patterns: ['circuit', 'geometric', 'tech'] },
                    'vintage': { colors: ['#8b0000', '#ffffff', '#ffd700'], patterns: ['stripes', 'classic', 'retro'] },
                    'nature': { colors: ['#228b22', '#8fbc8f', '#654321'], patterns: ['leaf', 'wood', 'organic'] },
                    'ocean': { colors: ['#0066cc', '#20b2aa', '#87ceeb'], patterns: ['wave', 'ripple', 'flow'] },
                    'fire': { colors: ['#ff4500', '#ff6347', '#ffd700'], patterns: ['flame', 'ember', 'heat'] },
                    'space': { colors: ['#191970', '#4b0082', '#8a2be2'], patterns: ['star', 'galaxy', 'cosmic'] },
                    'minimal': { colors: ['#000000', '#ffffff', '#808080'], patterns: ['geometric', 'clean', 'simple'] },
                    'tropical': { colors: ['#ff7f50', '#ffd700', '#32cd32'], patterns: ['palm', 'tropical', 'exotic'] },
                    'winter': { colors: ['#87ceeb', '#ffffff', '#b0e0e6'], patterns: ['snowflake', 'ice', 'frost'] },
                    'urban': { colors: ['#ff1493', '#00ff00', '#ffff00'], patterns: ['graffiti', 'street', 'urban'] },
                    'royal': { colors: ['#4b0082', '#ffd700', '#8b0000'], patterns: ['crown', 'royal', 'elegant'] },
                    'storm': { colors: ['#2f4f4f', '#ffff00', '#9370db'], patterns: ['lightning', 'storm', 'electric'] }
                },
                // Professional design templates for different sports and team styles
                sportsTemplates: {
                    'football': {
                        'professional': { colors: ['#002244', '#ffffff', '#c60c30'], patterns: ['stripes', 'geometric'], layout: 'classic', intensity: 'medium' },
                        'college': { colors: ['#8b0000', '#ffd700', '#ffffff'], patterns: ['tribal', 'bold'], layout: 'dynamic', intensity: 'high' },
                        'youth': { colors: ['#0066cc', '#ffffff', '#ff6600'], patterns: ['fun', 'playful'], layout: 'simple', intensity: 'medium' }
                    },
                    'basketball': {
                        'professional': { colors: ['#000000', '#ffffff', '#ffd700'], patterns: ['mesh', 'clean'], layout: 'modern', intensity: 'low' },
                        'streetball': { colors: ['#ff1493', '#00ff00', '#ffff00'], patterns: ['graffiti', 'urban'], layout: 'bold', intensity: 'high' },
                        'classic': { colors: ['#8b0000', '#ffffff', '#000000'], patterns: ['retro', 'vintage'], layout: 'traditional', intensity: 'medium' }
                    },
                    'soccer': {
                        'premier': { colors: ['#003366', '#ffffff', '#ff0000'], patterns: ['diagonal', 'elegant'], layout: 'sophisticated', intensity: 'medium' },
                        'national': { colors: ['#228b22', '#ffd700', '#ffffff'], patterns: ['flag', 'patriotic'], layout: 'bold', intensity: 'high' },
                        'club': { colors: ['#4b0082', '#ffd700', '#ffffff'], patterns: ['crest', 'traditional'], layout: 'classic', intensity: 'medium' }
                    },
                    'baseball': {
                        'major_league': { colors: ['#002244', '#ffffff', '#c60c30'], patterns: ['pinstripes', 'classic'], layout: 'traditional', intensity: 'low' },
                        'vintage': { colors: ['#8b4513', '#f5deb3', '#000000'], patterns: ['retro', 'heritage'], layout: 'nostalgic', intensity: 'medium' },
                        'modern': { colors: ['#1e90ff', '#ffffff', '#ff4500'], patterns: ['tech', 'sleek'], layout: 'contemporary', intensity: 'medium' }
                    },
                    'hockey': {
                        'professional': { colors: ['#000000', '#ffffff', '#c8102e'], patterns: ['ice', 'sharp'], layout: 'aggressive', intensity: 'high' },
                        'college': { colors: ['#003366', '#ffd700', '#ffffff'], patterns: ['frost', 'collegiate'], layout: 'spirited', intensity: 'medium' },
                        'youth': { colors: ['#0066cc', '#ffffff', '#ff6600'], patterns: ['fun', 'energetic'], layout: 'playful', intensity: 'medium' }
                    },
                    'esports': {
                        'competitive': { colors: ['#00ffff', '#ff00ff', '#000000'], patterns: ['digital', 'neon'], layout: 'futuristic', intensity: 'high' },
                        'streaming': { colors: ['#7b68ee', '#00ff7f', '#ff1493'], patterns: ['glow', 'electric'], layout: 'vibrant', intensity: 'high' },
                        'team': { colors: ['#4169e1', '#ffffff', '#ffd700'], patterns: ['tech', 'modern'], layout: 'professional', intensity: 'medium' }
                    }
                },
                // Team style categories
                teamStyles: {
                    'aggressive': { colors: ['#8b0000', '#000000', '#ff4500'], patterns: ['sharp', 'angular'], effects: ['shadow', 'bold'], intensity: 'high' },
                    'elegant': { colors: ['#000080', '#ffd700', '#ffffff'], patterns: ['flowing', 'sophisticated'], effects: ['subtle', 'refined'], intensity: 'low' },
                    'energetic': { colors: ['#ff6347', '#32cd32', '#1e90ff'], patterns: ['dynamic', 'vibrant'], effects: ['glow', 'motion'], intensity: 'high' },
                    'classic': { colors: ['#8b0000', '#ffffff', '#000080'], patterns: ['traditional', 'timeless'], effects: ['clean', 'simple'], intensity: 'medium' },
                    'modern': { colors: ['#2f4f4f', '#ffffff', '#ff6600'], patterns: ['geometric', 'minimalist'], effects: ['sleek', 'contemporary'], intensity: 'medium' },
                    'retro': { colors: ['#daa520', '#8b4513', '#f5deb3'], patterns: ['vintage', 'nostalgic'], effects: ['aged', 'classic'], intensity: 'medium' },
                    'futuristic': { colors: ['#00ffff', '#ff00ff', '#7fff00'], patterns: ['tech', 'digital'], effects: ['neon', 'holographic'], intensity: 'high' },
                    'natural': { colors: ['#228b22', '#8fbc8f', '#654321'], patterns: ['organic', 'earth'], effects: ['textured', 'natural'], intensity: 'medium' }
                },
                emotions: {
                    'aggressive': { colors: ['#ff0000', '#000000', '#ff4500'], intensity: 'high' },
                    'calm': { colors: ['#87ceeb', '#98fb98', '#f0f8ff'], intensity: 'low' },
                    'energetic': { colors: ['#ff1493', '#00ff00', '#ffff00'], intensity: 'high' },
                    'professional': { colors: ['#000080', '#ffffff', '#c0c0c0'], intensity: 'medium' },
                    'playful': { colors: ['#ff69b4', '#00bfff', '#32cd32'], intensity: 'high' },
                    'elegant': { colors: ['#4b0082', '#ffd700', '#ffffff'], intensity: 'low' }
                },
                sports: {
                    'soccer': { patterns: ['hexagon', 'net'], logos: ['ball', 'goal', 'field'] },
                    'basketball': { patterns: ['court', 'hoop'], logos: ['ball', 'hoop', 'court'] },
                    'football': { patterns: ['field', 'yard'], logos: ['helmet', 'field', 'goal'] },
                    'baseball': { patterns: ['diamond', 'stitch'], logos: ['bat', 'ball', 'diamond'] },
                    'hockey': { patterns: ['ice', 'rink'], logos: ['puck', 'stick', 'goal'] },
                    'tennis': { patterns: ['court', 'net'], logos: ['racket', 'ball', 'court'] }
                }
            };
            
            // Enhanced AI Natural Language Processing
            function parseAiPrompt(prompt) {
                const design = {
                    colors: [],
                    gradient: false,
                    gradientDirection: 'to right',
                    patterns: [],
                    logoPosition: 'center',
                    logoType: 'intelligent',
                    theme: null,
                    emotion: null,
                    sport: null,
                    complexity: 'medium',
                    textElements: []
                };
                
                const lowerPrompt = prompt.toLowerCase();
                const words = lowerPrompt.split(/\s+/);
                
                // Enhanced color recognition with context
                const colorMap = {
                    'red': '#ff0000', 'crimson': '#dc143c', 'scarlet': '#ff2400', 'cherry': '#de3163',
                    'blue': '#0000ff', 'navy': '#000080', 'royal': '#4169e1', 'sky': '#87ceeb', 'azure': '#007fff',
                    'green': '#00ff00', 'forest': '#228b22', 'lime': '#32cd32', 'emerald': '#50c878', 'mint': '#98fb98',
                    'yellow': '#ffff00', 'gold': '#ffd700', 'amber': '#ffbf00', 'lemon': '#fff700', 'canary': '#ffff99',
                    'orange': '#ffa500', 'tangerine': '#ff8c00', 'coral': '#ff7f50', 'peach': '#ffcba4',
                    'purple': '#800080', 'violet': '#ee82ee', 'indigo': '#4b0082', 'lavender': '#e6e6fa', 'magenta': '#ff00ff',
                    'pink': '#ffc0cb', 'rose': '#ff007f', 'fuchsia': '#ff00ff', 'salmon': '#fa8072',
                    'black': '#000000', 'charcoal': '#36454f', 'ebony': '#555d50', 'onyx': '#353839',
                    'white': '#ffffff', 'ivory': '#fffff0', 'pearl': '#f8f6f0', 'snow': '#fffafa',
                    'gray': '#808080', 'silver': '#c0c0c0', 'platinum': '#e5e4e2', 'steel': '#71797e',
                    'brown': '#a52a2a', 'chocolate': '#d2691e', 'coffee': '#6f4e37', 'bronze': '#cd7f32',
                    'cyan': '#00ffff', 'turquoise': '#40e0d0', 'teal': '#008080', 'aqua': '#00ffff',
                    'neon': '#39ff14', 'electric': '#7df9ff', 'glow': '#ffff33'
                };
                
                // Sports template detection
                Object.keys(aiKnowledgeBase.sportsTemplates).forEach(sport => {
                    if (words.some(word => word.includes(sport) || sport.includes(word))) {
                        design.sport = sport;
                        // Detect specific template within sport
                        Object.keys(aiKnowledgeBase.sportsTemplates[sport]).forEach(template => {
                            if (words.some(word => word.includes(template) || template.includes(word))) {
                                const templateData = aiKnowledgeBase.sportsTemplates[sport][template];
                                design.template = template;
                                design.colors = [...templateData.colors];
                                design.patterns = [...templateData.patterns];
                                design.layout = templateData.layout;
                                design.intensity = templateData.intensity;
                            }
                        });
                        // If no specific template found, use professional as default
                        if (!design.template && aiKnowledgeBase.sportsTemplates[sport]['professional']) {
                            const templateData = aiKnowledgeBase.sportsTemplates[sport]['professional'];
                            design.template = 'professional';
                            design.colors = [...templateData.colors];
                            design.patterns = [...templateData.patterns];
                            design.layout = templateData.layout;
                            design.intensity = templateData.intensity;
                        }
                    }
                });
                
                // Team style detection
                Object.keys(aiKnowledgeBase.teamStyles).forEach(style => {
                    if (words.some(word => word.includes(style) || style.includes(word))) {
                        const styleData = aiKnowledgeBase.teamStyles[style];
                        design.teamStyle = style;
                        if (!design.colors || design.colors.length === 0) {
                            design.colors = [...styleData.colors];
                        }
                        if (!design.patterns || design.patterns.length === 0) {
                            design.patterns = [...styleData.patterns];
                        }
                        design.effects = [...styleData.effects];
                        design.intensity = styleData.intensity;
                    }
                });
                
                // Intelligent theme detection (fallback if no sports template found)
                if (!design.sport && !design.teamStyle) {
                    Object.keys(aiKnowledgeBase.themes).forEach(theme => {
                        if (words.some(word => word.includes(theme) || theme.includes(word))) {
                            design.theme = theme;
                            design.colors = [...aiKnowledgeBase.themes[theme].colors];
                            design.patterns = [...aiKnowledgeBase.themes[theme].patterns];
                        }
                    });
                }
                
                // Emotion detection
                Object.keys(aiKnowledgeBase.emotions).forEach(emotion => {
                    if (words.some(word => word.includes(emotion) || emotion.includes(word))) {
                        design.emotion = emotion;
                        if (!design.theme) {
                            design.colors = [...aiKnowledgeBase.emotions[emotion].colors];
                        }
                        design.complexity = aiKnowledgeBase.emotions[emotion].intensity;
                    }
                });
                
                // Sport detection
                Object.keys(aiKnowledgeBase.sports).forEach(sport => {
                    if (words.some(word => word.includes(sport) || sport.includes(word))) {
                        design.sport = sport;
                        design.patterns.push(...aiKnowledgeBase.sports[sport].patterns);
                    }
                });
                
                // Enhanced color parsing with context
                Object.keys(colorMap).forEach(colorName => {
                    if (lowerPrompt.includes(colorName)) {
                        if (!design.colors.includes(colorMap[colorName])) {
                            design.colors.push(colorMap[colorName]);
                        }
                    }
                });
                
                // Intelligent gradient detection
                const gradientKeywords = ['gradient', 'fade', 'blend', 'transition', 'ombre', 'spectrum'];
                if (gradientKeywords.some(keyword => lowerPrompt.includes(keyword))) {
                    design.gradient = true;
                    if (lowerPrompt.includes('vertical') || lowerPrompt.includes('up') || lowerPrompt.includes('down')) {
                        design.gradientDirection = 'to bottom';
                    } else if (lowerPrompt.includes('diagonal') || lowerPrompt.includes('corner')) {
                        design.gradientDirection = 'to bottom right';
                    } else if (lowerPrompt.includes('radial') || lowerPrompt.includes('circular') || lowerPrompt.includes('center')) {
                        design.gradientDirection = 'circle at center';
                    }
                }
                
                // Advanced logo position detection
                const positionMap = {
                    'center': ['center', 'middle', 'heart', 'core'],
                    'chest': ['chest', 'front', 'top', 'upper', 'breast'],
                    'sleeve': ['sleeve', 'arm', 'shoulder', 'side'],
                    'back': ['back', 'rear', 'behind', 'spine']
                };
                
                Object.keys(positionMap).forEach(position => {
                    if (positionMap[position].some(keyword => lowerPrompt.includes(keyword))) {
                        design.logoPosition = position;
                    }
                });
                
                // Text element extraction
                const textMatches = prompt.match(/"([^"]+)"/g) || prompt.match(/'([^']+)'/g);
                if (textMatches) {
                    design.textElements = textMatches.map(match => match.replace(/["']/g, ''));
                }
                
                // Intelligent color harmony if no colors specified
                if (design.colors.length === 0) {
                    design.colors = generateColorHarmony(design.theme, design.emotion);
                }
                
                // Ensure gradient has at least 2 colors
                if (design.gradient && design.colors.length === 1) {
                    const harmonicColor = generateHarmonicColor(design.colors[0]);
                    design.colors.push(harmonicColor);
                } else if (design.gradient && design.colors.length === 0) {
                    design.colors = generateColorHarmony('random', 'energetic');
                }
                
                return design;
            }
            
            // Generate advanced color harmony based on sophisticated color theory
            function generateColorHarmony(theme, emotion) {
                const harmonies = {
                    complementary: (base) => [base, getComplementaryColor(base)],
                    triadic: (base) => [base, rotateHue(base, 120), rotateHue(base, 240)],
                    analogous: (base) => [base, rotateHue(base, 30), rotateHue(base, -30)],
                    monochromatic: (base) => [base, adjustBrightness(base, 0.3), adjustBrightness(base, -0.3)],
                    splitComplementary: (base) => [base, rotateHue(base, 150), rotateHue(base, 210)],
                    tetradic: (base) => [base, rotateHue(base, 90), rotateHue(base, 180), rotateHue(base, 270)],
                    compound: (base) => [base, rotateHue(base, 60), getComplementaryColor(base), rotateHue(getComplementaryColor(base), 60)]
                };
                
                if (theme && aiKnowledgeBase.themes[theme]) {
                    return enhanceThemeColors(aiKnowledgeBase.themes[theme].colors.slice(0, 2), emotion);
                }
                
                if (emotion && aiKnowledgeBase.emotions[emotion]) {
                    return aiKnowledgeBase.emotions[emotion].colors.slice(0, 2);
                }
                
                // Generate random harmony
                const baseColor = '#' + Math.floor(Math.random()*16777215).toString(16).padStart(6, '0');
                const harmonyTypes = Object.keys(harmonies);
                const randomHarmony = harmonyTypes[Math.floor(Math.random() * harmonyTypes.length)];
                return harmonies[randomHarmony](baseColor);
            }
            
            // Color theory helper functions
            function getComplementaryColor(hex) {
                const rgb = hexToRgb(hex);
                return rgbToHex(255 - rgb.r, 255 - rgb.g, 255 - rgb.b);
            }
            
            function rotateHue(hex, degrees) {
                const hsl = rgbToHsl(...Object.values(hexToRgb(hex)));
                hsl.h = (hsl.h + degrees) % 360;
                const rgb = hslToRgb(hsl.h, hsl.s, hsl.l);
                return rgbToHex(rgb.r, rgb.g, rgb.b);
            }
            
            function adjustBrightness(hex, factor) {
                const rgb = hexToRgb(hex);
                return rgbToHex(
                    Math.min(255, Math.max(0, rgb.r + (rgb.r * factor))),
                    Math.min(255, Math.max(0, rgb.g + (rgb.g * factor))),
                    Math.min(255, Math.max(0, rgb.b + (rgb.b * factor)))
                );
            }
            
            function generateHarmonicColor(baseColor) {
                return rotateHue(baseColor, 60 + Math.random() * 120);
            }
            
            // Color conversion utilities
            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? {
                    r: parseInt(result[1], 16),
                    g: parseInt(result[2], 16),
                    b: parseInt(result[3], 16)
                } : null;
            }
            
            function rgbToHex(r, g, b) {
                return '#' + [r, g, b].map(x => {
                    const hex = Math.round(x).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            }
            
            function rgbToHsl(r, g, b) {
                r /= 255; g /= 255; b /= 255;
                const max = Math.max(r, g, b), min = Math.min(r, g, b);
                let h, s, l = (max + min) / 2;
                
                if (max === min) {
                    h = s = 0;
                } else {
                    const d = max - min;
                    s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
                    switch (max) {
                        case r: h = (g - b) / d + (g < b ? 6 : 0); break;
                        case g: h = (b - r) / d + 2; break;
                        case b: h = (r - g) / d + 4; break;
                    }
                    h /= 6;
                }
                
                return { h: h * 360, s: s, l: l };
            }
            
            function hslToRgb(h, s, l) {
                h /= 360;
                const hue2rgb = (p, q, t) => {
                    if (t < 0) t += 1;
                    if (t > 1) t -= 1;
                    if (t < 1/6) return p + (q - p) * 6 * t;
                    if (t < 1/2) return q;
                    if (t < 2/3) return p + (q - p) * (2/3 - t) * 6;
                    return p;
                };
                
                let r, g, b;
                if (s === 0) {
                    r = g = b = l;
                } else {
                    const q = l < 0.5 ? l * (1 + s) : l + s - l * s;
                    const p = 2 * l - q;
                    r = hue2rgb(p, q, h + 1/3);
                    g = hue2rgb(p, q, h);
                    b = hue2rgb(p, q, h - 1/3);
                }
                
                return { r: Math.round(r * 255), g: Math.round(g * 255), b: Math.round(b * 255) };
            }
            
            // Advanced color theory helper functions
            function getComplementaryColor(hexColor) {
                const hsl = hexToHsl(hexColor);
                return hslToHex((hsl.h + 180) % 360, hsl.s, hsl.l);
            }
            
            function rotateHue(hexColor, degrees) {
                const hsl = hexToHsl(hexColor);
                return hslToHex((hsl.h + degrees + 360) % 360, hsl.s, hsl.l);
            }
            
            function adjustBrightness(hexColor, amount) {
                const hsl = hexToHsl(hexColor);
                const newL = Math.max(0, Math.min(1, hsl.l + amount));
                return hslToHex(hsl.h, hsl.s, newL);
            }
            
            function adjustSaturation(hexColor, amount) {
                const hsl = hexToHsl(hexColor);
                const newS = Math.max(0, Math.min(1, hsl.s + amount));
                return hslToHex(hsl.h, newS, hsl.l);
            }
            
            function enhanceThemeColors(baseColors, emotion) {
                if (!baseColors || baseColors.length === 0) return ['#0066cc', '#ffffff'];
                
                const enhanced = [...baseColors];
                
                // Apply emotion-based color adjustments
                switch (emotion) {
                    case 'energetic':
                    case 'aggressive':
                        return enhanced.map(color => adjustSaturation(adjustBrightness(color, 0.1), 0.2));
                    case 'calm':
                    case 'peaceful':
                        return enhanced.map(color => adjustSaturation(adjustBrightness(color, -0.1), -0.2));
                    case 'elegant':
                    case 'sophisticated':
                        return enhanced.map(color => adjustSaturation(color, -0.1));
                    case 'playful':
                    case 'fun':
                        return enhanced.map(color => adjustSaturation(color, 0.3));
                    default:
                        return enhanced;
                }
            }
            
            function generateAdvancedColorPalette(baseColor, theme, emotion, complexity = 'medium') {
                const palettes = [];
                
                // Generate different harmony types based on complexity
                const harmonyTypes = complexity === 'high' 
                    ? ['complementary', 'triadic', 'splitComplementary', 'tetradic']
                    : complexity === 'low'
                    ? ['complementary', 'analogous']
                    : ['complementary', 'triadic', 'analogous'];
                
                harmonyTypes.forEach(harmonyType => {
                    switch (harmonyType) {
                        case 'complementary':
                            palettes.push([baseColor, getComplementaryColor(baseColor)]);
                            break;
                        case 'triadic':
                            palettes.push([baseColor, rotateHue(baseColor, 120), rotateHue(baseColor, 240)]);
                            break;
                        case 'analogous':
                            palettes.push([rotateHue(baseColor, -30), baseColor, rotateHue(baseColor, 30)]);
                            break;
                        case 'splitComplementary':
                            palettes.push([baseColor, rotateHue(baseColor, 150), rotateHue(baseColor, 210)]);
                            break;
                        case 'tetradic':
                            palettes.push([baseColor, rotateHue(baseColor, 90), rotateHue(baseColor, 180), rotateHue(baseColor, 270)]);
                            break;
                    }
                });
                
                // Select best palette based on theme and emotion
                const bestPalette = selectOptimalPalette(palettes, theme, emotion);
                return enhanceThemeColors(bestPalette, emotion);
            }
            
            function selectOptimalPalette(palettes, theme, emotion) {
                if (!palettes || palettes.length === 0) return ['#0066cc', '#ffffff'];
                
                // Theme-based palette selection
                const themePreferences = {
                    'futuristic': 'complementary',
                    'tech': 'complementary',
                    'nature': 'analogous',
                    'ocean': 'analogous',
                    'fire': 'triadic',
                    'space': 'tetradic',
                    'minimal': 'complementary',
                    'royal': 'splitComplementary'
                };
                
                const preferredType = themePreferences[theme] || 'complementary';
                
                // Return palette that matches preference or first available
                return palettes.find(palette => {
                    switch (preferredType) {
                        case 'complementary': return palette.length === 2;
                        case 'triadic': return palette.length === 3;
                        case 'analogous': return palette.length === 3;
                        case 'splitComplementary': return palette.length === 3;
                        case 'tetradic': return palette.length === 4;
                        default: return true;
                    }
                }) || palettes[0] || ['#0066cc', '#ffffff'];
            }
            
            function applyAiDesign(design) {
                console.log('Applying AI design:', design);
                
                // Ensure we have colors - add fallbacks if needed
                if (!design.colors || design.colors.length === 0) {
                    design.colors = ['#0066cc', '#ffffff']; // Default blue and white
                    console.log('No colors detected, using defaults:', design.colors);
                }
                
                // Apply colors with enhanced logic
                if (design.gradient && design.colors.length >= 2) {
                    console.log('Applying gradient with colors:', design.colors);
                    // Switch to gradient mode
                    gradientColorRadio.checked = true;
                    solidColorOptions.style.display = 'none';
                    gradientColorOptions.style.display = 'block';
                    
                    // Set gradient colors in the order they appear in the prompt
                    gradientStartColor.value = design.colors[0];
                    gradientEndColor.value = design.colors[1];
                    gradientDirection.value = design.gradientDirection || 'to right';
                    
                    // Trigger change events to ensure UI updates
                    gradientStartColor.dispatchEvent(new Event('input'));
                    gradientEndColor.dispatchEvent(new Event('input'));
                    gradientDirection.dispatchEvent(new Event('change'));
                    
                    // Update gradient
                    updateGradientPreview();
                    updateColors();
                } else {
                    console.log('Applying solid color:', design.colors[0]);
                    // Switch to solid color mode
                    solidColorRadio.checked = true;
                    solidColorOptions.style.display = 'block';
                    gradientColorOptions.style.display = 'none';
                    
                    // Set main color
                    mainColor.value = design.colors[0] || '#0066cc';
                    
                    // Trigger change event to ensure UI updates
                    mainColor.dispatchEvent(new Event('input'));
                    
                    updateColors();
                }
                
                // Force a visual update
                setTimeout(() => {
                    updateColors();
                }, 100);
                
                // Apply patterns if specified
                if (design.patterns && design.patterns.length > 0) {
                    applyIntelligentPatterns(design.patterns, design.theme, design.complexity);
                }
                
                // Skip logo generation - focus on colors and patterns only
                // Logo generation removed to focus on visual design elements
                
                // Apply text elements if any
                if (design.textElements && design.textElements.length > 0) {
                    applyTextElements(design.textElements);
                }
                
                // Enhanced color application for better visual impact
                applyEnhancedColorEffects(design);
                
                // Apply theme-specific enhancements
                if (design.theme) {
                    applyThemeEnhancements(design.theme, design.emotion);
                }
            }
            
            // Apply intelligent patterns based on design context
            function applyIntelligentPatterns(patterns, theme, complexity) {
                const jerseyFront = document.querySelector('.jersey-front');
                const jerseyBack = document.querySelector('.jersey-back');
                
                if (!jerseyFront) return;
                
                // Remove existing patterns
                const existingPatterns = jerseyFront.querySelectorAll('.ai-pattern');
                existingPatterns.forEach(pattern => pattern.remove());
                
                patterns.forEach((patternType, index) => {
                    const patternElement = createPatternElement(patternType, theme, complexity, index);
                    if (patternElement) {
                        patternElement.classList.add('ai-pattern');
                        jerseyFront.appendChild(patternElement);
                        
                        // Apply to back jersey too for some patterns
                        if (jerseyBack && ['geometric', 'circuit', 'star'].includes(patternType)) {
                            const backPattern = patternElement.cloneNode(true);
                            jerseyBack.appendChild(backPattern);
                        }
                    }
                });
            }
            
            // Create pattern elements based on type
            function createPatternElement(patternType, theme, complexity, index) {
                const patternDiv = document.createElement('div');
                patternDiv.style.position = 'absolute';
                patternDiv.style.pointerEvents = 'none';
                patternDiv.style.zIndex = '1';
                
                const intensityMap = { 'low': 0.3, 'medium': 0.6, 'high': 0.9 };
                const opacity = intensityMap[complexity] || 0.6;
                
                switch (patternType) {
                    case 'circuit':
                        return createCircuitPattern(patternDiv, opacity, index);
                    case 'geometric':
                        return createGeometricPattern(patternDiv, opacity, index);
                    case 'stripes':
                        return createStripesPattern(patternDiv, opacity, index);
                    case 'wave':
                        return createWavePattern(patternDiv, opacity, index);
                    case 'flame':
                        return createFlamePattern(patternDiv, opacity, index);
                    case 'star':
                        return createStarPattern(patternDiv, opacity, index);
                    case 'leaf':
                        return createLeafPattern(patternDiv, opacity, index);
                    case 'lightning':
                        return createLightningPattern(patternDiv, opacity, index);
                    case 'hexagonal':
                        return createHexagonalPattern(patternDiv, opacity, index);
                    case 'tribal':
                        return createTribalPattern(patternDiv, opacity, index);
                    case 'tech':
                        return createTechPattern(patternDiv, opacity, index);
                    case 'organic':
                        return createOrganicPattern(patternDiv, opacity, index);
                    case 'diamond':
                        return createDiamondPattern(patternDiv, opacity, index);
                    case 'spiral':
                        return createSpiralPattern(patternDiv, opacity, index);
                    case 'mesh':
                        return createMeshPattern(patternDiv, opacity, index);
                    case 'carbon':
                        return createCarbonPattern(patternDiv, opacity, index);
                    default:
                        return createGeometricPattern(patternDiv, opacity, index);
                }
            }
            
            // Pattern creation functions
            function createCircuitPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="circuit-${index}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                                <rect width="40" height="40" fill="none"/>
                                <path d="M10,10 L30,10 L30,30 L10,30 Z" stroke="#00ffff" stroke-width="1" fill="none"/>
                                <circle cx="20" cy="20" r="2" fill="#00ffff"/>
                                <line x1="0" y1="20" x2="10" y2="20" stroke="#00ffff" stroke-width="1"/>
                                <line x1="30" y1="20" x2="40" y2="20" stroke="#00ffff" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#circuit-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createGeometricPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="geometric-${index}" x="0" y="0" width="30" height="30" patternUnits="userSpaceOnUse">
                                <polygon points="15,5 25,20 5,20" fill="rgba(255,255,255,0.3)" stroke="rgba(255,255,255,0.5)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#geometric-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createStripesPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="stripes-${index}" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                <rect width="10" height="20" fill="rgba(255,255,255,0.2)"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#stripes-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createWavePattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="wave-${index}" x="0" y="0" width="60" height="30" patternUnits="userSpaceOnUse">
                                <path d="M0,15 Q15,5 30,15 T60,15" stroke="rgba(255,255,255,0.4)" stroke-width="2" fill="none"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#wave-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createFlamePattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="flame-${index}" x="0" y="0" width="40" height="60" patternUnits="userSpaceOnUse">
                                <path d="M20,50 Q10,30 20,20 Q30,30 20,10 Q25,25 20,50" fill="rgba(255,100,0,0.3)" stroke="rgba(255,150,0,0.5)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#flame-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createStarPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="star-${index}" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse">
                                <polygon points="25,5 30,20 45,20 33,30 38,45 25,35 12,45 17,30 5,20 20,20" fill="rgba(255,255,0,0.3)" stroke="rgba(255,255,0,0.5)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#star-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createLeafPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="leaf-${index}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                                <path d="M20,5 Q30,15 20,25 Q10,15 20,5" fill="rgba(0,255,0,0.3)" stroke="rgba(0,200,0,0.5)" stroke-width="1"/>
                                <line x1="20" y1="5" x2="20" y2="25" stroke="rgba(0,150,0,0.4)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#leaf-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createLightningPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="lightning-${index}" x="0" y="0" width="30" height="50" patternUnits="userSpaceOnUse">
                                <path d="M15,5 L10,20 L20,20 L15,45 L25,25 L15,25 Z" fill="rgba(255,255,0,0.4)" stroke="rgba(255,255,100,0.6)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#lightning-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createHexagonalPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="hexagonal-${index}" x="0" y="0" width="60" height="52" patternUnits="userSpaceOnUse">
                                <polygon points="30,4 45,15 45,35 30,46 15,35 15,15" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.5"/>
                                <polygon points="0,26 15,17 15,35" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                                <polygon points="60,26 45,17 45,35" fill="none" stroke="rgba(255,255,255,0.3)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#hexagonal-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createTribalPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="tribal-${index}" x="0" y="0" width="80" height="80" patternUnits="userSpaceOnUse">
                                <path d="M40,10 Q50,20 40,30 Q30,20 40,10" fill="rgba(255,255,255,0.3)"/>
                                <path d="M20,40 Q30,50 20,60 Q10,50 20,40" fill="rgba(255,255,255,0.25)"/>
                                <path d="M60,40 Q70,50 60,60 Q50,50 60,40" fill="rgba(255,255,255,0.25)"/>
                                <path d="M40,70 Q50,60 40,50 Q30,60 40,70" fill="rgba(255,255,255,0.3)"/>
                                <circle cx="40" cy="40" r="3" fill="rgba(255,255,255,0.4)"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#tribal-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createTechPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="tech-${index}" x="0" y="0" width="50" height="50" patternUnits="userSpaceOnUse">
                                <rect x="10" y="10" width="30" height="30" fill="none" stroke="rgba(0,255,255,0.4)" stroke-width="1"/>
                                <rect x="15" y="15" width="20" height="20" fill="none" stroke="rgba(0,255,255,0.3)" stroke-width="1"/>
                                <circle cx="25" cy="25" r="5" fill="none" stroke="rgba(0,255,255,0.5)" stroke-width="1"/>
                                <line x1="0" y1="25" x2="10" y2="25" stroke="rgba(0,255,255,0.4)" stroke-width="1"/>
                                <line x1="40" y1="25" x2="50" y2="25" stroke="rgba(0,255,255,0.4)" stroke-width="1"/>
                                <line x1="25" y1="0" x2="25" y2="10" stroke="rgba(0,255,255,0.4)" stroke-width="1"/>
                                <line x1="25" y1="40" x2="25" y2="50" stroke="rgba(0,255,255,0.4)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#tech-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createOrganicPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="organic-${index}" x="0" y="0" width="70" height="70" patternUnits="userSpaceOnUse">
                                <path d="M35,10 Q50,25 35,40 Q20,25 35,10" fill="rgba(0,200,100,0.3)" stroke="rgba(0,150,75,0.4)" stroke-width="1"/>
                                <path d="M10,35 Q25,50 40,35 Q25,20 10,35" fill="rgba(0,200,100,0.25)" stroke="rgba(0,150,75,0.3)" stroke-width="1"/>
                                <path d="M60,35 Q45,20 30,35 Q45,50 60,35" fill="rgba(0,200,100,0.25)" stroke="rgba(0,150,75,0.3)" stroke-width="1"/>
                                <circle cx="35" cy="35" r="2" fill="rgba(0,180,90,0.5)"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#organic-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createDiamondPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="diamond-${index}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                                <polygon points="20,5 35,20 20,35 5,20" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="1.5"/>
                                <polygon points="20,10 30,20 20,30 10,20" fill="rgba(255,255,255,0.2)"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#diamond-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createSpiralPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="spiral-${index}" x="0" y="0" width="60" height="60" patternUnits="userSpaceOnUse">
                                <path d="M30,10 Q45,15 40,30 Q35,45 20,40 Q5,35 10,20 Q15,5 30,10" fill="none" stroke="rgba(255,255,255,0.4)" stroke-width="2"/>
                                <circle cx="30" cy="30" r="3" fill="rgba(255,255,255,0.3)"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#spiral-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createMeshPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="mesh-${index}" x="0" y="0" width="20" height="20" patternUnits="userSpaceOnUse">
                                <line x1="0" y1="0" x2="20" y2="0" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                                <line x1="0" y1="0" x2="0" y2="20" stroke="rgba(255,255,255,0.3)" stroke-width="0.5"/>
                                <line x1="0" y1="10" x2="20" y2="10" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                                <line x1="10" y1="0" x2="10" y2="20" stroke="rgba(255,255,255,0.2)" stroke-width="0.5"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#mesh-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            function createCarbonPattern(container, opacity, index) {
                container.innerHTML = `
                    <svg width="100%" height="100%" style="opacity: ${opacity}">
                        <defs>
                            <pattern id="carbon-${index}" x="0" y="0" width="40" height="40" patternUnits="userSpaceOnUse">
                                <rect width="40" height="40" fill="rgba(50,50,50,0.2)"/>
                                <circle cx="10" cy="10" r="8" fill="none" stroke="rgba(100,100,100,0.4)" stroke-width="1"/>
                                <circle cx="30" cy="10" r="8" fill="none" stroke="rgba(100,100,100,0.4)" stroke-width="1"/>
                                <circle cx="20" cy="30" r="8" fill="none" stroke="rgba(100,100,100,0.4)" stroke-width="1"/>
                                <line x1="18" y1="10" x2="22" y2="10" stroke="rgba(120,120,120,0.5)" stroke-width="1"/>
                                <line x1="10" y1="18" x2="10" y2="22" stroke="rgba(120,120,120,0.5)" stroke-width="1"/>
                                <line x1="30" y1="18" x2="30" y2="22" stroke="rgba(120,120,120,0.5)" stroke-width="1"/>
                            </pattern>
                        </defs>
                        <rect width="100%" height="100%" fill="url(#carbon-${index})"/>
                    </svg>
                `;
                container.style.top = '0';
                container.style.left = '0';
                container.style.width = '100%';
                container.style.height = '100%';
                return container;
            }
            
            // Generate intelligent logo based on design context
            function generateIntelligentLogo(design) {
                const logoContainer = document.querySelector('.logo-overlay');
                if (!logoContainer) return;
                
                // Clear existing logo
                logoContainer.innerHTML = '';
                
                // Determine logo type based on theme and sport
                let logoType = 'abstract';
                if (design.sport) {
                    logoType = design.sport;
                } else if (design.theme) {
                    const themeLogoMap = {
                        'futuristic': 'tech',
                        'nature': 'leaf',
                        'fire': 'flame',
                        'water': 'wave',
                        'electric': 'lightning',
                        'space': 'star',
                        'geometric': 'geometric'
                    };
                    logoType = themeLogoMap[design.theme] || 'abstract';
                }
                
                const logo = createIntelligentLogoSVG(logoType, design.colors, design.logoPosition);
                logoContainer.appendChild(logo);
                logoContainer.style.display = 'block';
            }
            
            // Create intelligent logo SVG
            function createIntelligentLogoSVG(logoType, colors, position = 'center') {
                const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
                svg.setAttribute('width', '80');
                svg.setAttribute('height', '80');
                svg.setAttribute('viewBox', '0 0 80 80');
                svg.style.position = 'absolute';
                
                const primaryColor = colors[0] || '#ffffff';
                const secondaryColor = colors[1] || adjustColorBrightness(primaryColor, -30);
                
                // Position the logo
                const positions = {
                    'center': { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                    'top-left': { top: '20%', left: '20%' },
                    'top-right': { top: '20%', right: '20%' },
                    'bottom-left': { bottom: '20%', left: '20%' },
                    'bottom-right': { bottom: '20%', right: '20%' }
                };
                
                const pos = positions[position] || positions['center'];
                Object.assign(svg.style, pos);
                
                // Create logo based on type
                switch (logoType) {
                    case 'football':
                    case 'soccer':
                        svg.innerHTML = `
                            <circle cx="40" cy="40" r="35" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                            <path d="M25,25 L55,25 L55,55 L25,55 Z" fill="none" stroke="${secondaryColor}" stroke-width="2"/>
                            <path d="M25,40 L55,40" stroke="${secondaryColor}" stroke-width="2"/>
                            <path d="M40,25 L40,55" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'basketball':
                        svg.innerHTML = `
                            <circle cx="40" cy="40" r="35" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                            <path d="M40,5 Q20,40 40,75 Q60,40 40,5" fill="none" stroke="${secondaryColor}" stroke-width="2"/>
                            <path d="M5,40 Q40,20 75,40 Q40,60 5,40" fill="none" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'tech':
                        svg.innerHTML = `
                            <rect x="20" y="20" width="40" height="40" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                            <circle cx="40" cy="40" r="8" fill="${secondaryColor}"/>
                            <line x1="10" y1="40" x2="20" y2="40" stroke="${secondaryColor}" stroke-width="2"/>
                            <line x1="60" y1="40" x2="70" y2="40" stroke="${secondaryColor}" stroke-width="2"/>
                            <line x1="40" y1="10" x2="40" y2="20" stroke="${secondaryColor}" stroke-width="2"/>
                            <line x1="40" y1="60" x2="40" y2="70" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'flame':
                        svg.innerHTML = `
                            <path d="M40,70 Q25,50 40,40 Q55,50 40,30 Q50,45 40,20 Q45,35 40,10 Q35,25 40,70" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'star':
                        svg.innerHTML = `
                            <polygon points="40,10 45,30 65,30 50,42 55,62 40,50 25,62 30,42 15,30 35,30" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'lightning':
                        svg.innerHTML = `
                            <path d="M35,10 L25,35 L45,35 L30,70 L50,45 L35,45 Z" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'wave':
                        svg.innerHTML = `
                            <path d="M10,40 Q25,20 40,40 T70,40" stroke="${primaryColor}" stroke-width="4" fill="none"/>
                            <path d="M10,50 Q25,30 40,50 T70,50" stroke="${secondaryColor}" stroke-width="3" fill="none"/>
                        `;
                        break;
                    case 'leaf':
                        svg.innerHTML = `
                            <path d="M40,10 Q60,30 40,60 Q20,30 40,10" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                            <line x1="40" y1="10" x2="40" y2="60" stroke="${secondaryColor}" stroke-width="2"/>
                        `;
                        break;
                    case 'geometric':
                        svg.innerHTML = `
                            <polygon points="40,15 60,35 40,65 20,35" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                            <polygon points="40,25 50,35 40,55 30,35" fill="${secondaryColor}"/>
                        `;
                        break;
                    default: // abstract
                        svg.innerHTML = `
                            <polygon points="40,15 60,35 40,65 20,35" fill="${primaryColor}" stroke="${secondaryColor}" stroke-width="2"/>
                            <circle cx="40" cy="40" r="8" fill="${secondaryColor}"/>
                        `;
                }
                
                return svg;
            }
            
            // Apply text elements to the jersey
            function applyTextElements(textElements) {
                textElements.forEach((textElement, index) => {
                    const textDiv = document.createElement('div');
                    textDiv.className = 'ai-text-element';
                    textDiv.style.position = 'absolute';
                    textDiv.style.color = textElement.color || '#ffffff';
                    textDiv.style.fontSize = textElement.size || '16px';
                    textDiv.style.fontWeight = textElement.weight || 'bold';
                    textDiv.style.textShadow = '2px 2px 4px rgba(0,0,0,0.5)';
                    textDiv.style.zIndex = '10';
                    textDiv.textContent = textElement.text;
                    
                    // Position text
                    const positions = {
                        'top': { top: '15%', left: '50%', transform: 'translateX(-50%)' },
                        'center': { top: '50%', left: '50%', transform: 'translate(-50%, -50%)' },
                        'bottom': { bottom: '15%', left: '50%', transform: 'translateX(-50%)' }
                    };
                    
                    const pos = positions[textElement.position] || positions['center'];
                    Object.assign(textDiv.style, pos);
                    
                    const jerseyContainer = document.querySelector('.jersey-front');
                    if (jerseyContainer) {
                        jerseyContainer.appendChild(textDiv);
                    }
                });
            }
            
            // Apply theme-specific enhancements
            function applyThemeEnhancements(theme, emotion) {
                const jerseyContainer = document.querySelector('.apparel-container');
                if (!jerseyContainer) return;
                
                // Remove existing theme classes
                jerseyContainer.classList.remove('theme-futuristic', 'theme-nature', 'theme-fire', 'theme-water', 'theme-electric');
                
                // Add theme class
                if (theme) {
                    jerseyContainer.classList.add(`theme-${theme}`);
                }
                
                // Apply emotion-based effects
                if (emotion) {
                    applyEmotionEffects(emotion, jerseyContainer);
                }
            }
            
            // Apply emotion-based visual effects
            function applyEmotionEffects(emotion, container) {
                const effectsMap = {
                    'energetic': 'filter: brightness(1.1) saturate(1.2);',
                    'calm': 'filter: brightness(0.9) saturate(0.8);',
                    'aggressive': 'filter: contrast(1.2) saturate(1.3);',
                    'elegant': 'filter: brightness(1.05) contrast(1.1);',
                    'playful': 'filter: hue-rotate(10deg) saturate(1.1);',
                    'professional': 'filter: contrast(1.1) saturate(0.9);'
                };
                
                const effect = effectsMap[emotion];
                if (effect) {
                    container.style.cssText += effect;
                }
            }
            
            // Enhanced color effects for better visual impact
            function applyEnhancedColorEffects(design) {
                const jerseyFront = document.querySelector('.jersey-front');
                const jerseyBack = document.querySelector('.jersey-back');
                
                if (!jerseyFront) return;
                
                // Apply subtle color overlays based on theme
                if (design.theme) {
                    applyThemeColorOverlay(jerseyFront, design.theme, design.colors);
                    if (jerseyBack) applyThemeColorOverlay(jerseyBack, design.theme, design.colors);
                }
                
                // Add gradient accents for modern designs
                if (design.gradient && design.colors.length >= 2) {
                    addGradientAccents(jerseyFront, design.colors, design.gradientDirection);
                    if (jerseyBack) addGradientAccents(jerseyBack, design.colors, design.gradientDirection);
                }
                
                // Apply advanced visual effects
                applyAdvancedVisualEffects(jerseyFront, design);
                if (jerseyBack) applyAdvancedVisualEffects(jerseyBack, design);
                
                // Apply color-based visual enhancements
                applyColorBasedEnhancements(jerseyFront, design.colors, design.theme);
                if (jerseyBack) applyColorBasedEnhancements(jerseyBack, design.colors, design.theme);
            }
            
            // Apply theme-based color overlays
            function applyThemeColorOverlay(container, theme, colors) {
                // Remove existing overlays
                const existingOverlays = container.querySelectorAll('.theme-overlay');
                existingOverlays.forEach(overlay => overlay.remove());
                
                const overlay = document.createElement('div');
                overlay.className = 'theme-overlay';
                overlay.style.position = 'absolute';
                overlay.style.top = '0';
                overlay.style.left = '0';
                overlay.style.width = '100%';
                overlay.style.height = '100%';
                overlay.style.pointerEvents = 'none';
                overlay.style.zIndex = '2';
                
                const primaryColor = colors[0] || '#0066cc';
                const secondaryColor = colors[1] || colors[0] || '#0066cc';
                
                switch (theme) {
                    case 'modern':
                        overlay.style.background = `linear-gradient(135deg, ${primaryColor}15, ${secondaryColor}10)`;
                        break;
                    case 'futuristic':
                        overlay.style.background = `radial-gradient(circle at 30% 70%, ${primaryColor}20, transparent 50%)`;
                        overlay.style.boxShadow = `inset 0 0 50px ${primaryColor}30`;
                        break;
                    case 'nature':
                        overlay.style.background = `linear-gradient(45deg, ${primaryColor}12, ${secondaryColor}08)`;
                        break;
                    case 'sports':
                        overlay.style.background = `linear-gradient(90deg, ${primaryColor}18, transparent 30%, ${secondaryColor}15)`;
                        break;
                    default:
                        overlay.style.background = `linear-gradient(135deg, ${primaryColor}10, ${secondaryColor}08)`;
                }
                
                container.appendChild(overlay);
            }
            
            // Add gradient accents for visual appeal
            function addGradientAccents(container, colors, direction) {
                const accent = document.createElement('div');
                accent.className = 'gradient-accent';
                accent.style.position = 'absolute';
                accent.style.pointerEvents = 'none';
                accent.style.zIndex = '1';
                
                const primaryColor = colors[0] || '#0066cc';
                const secondaryColor = colors[1] || colors[0] || '#0066cc';
                
                // Create subtle accent based on gradient direction
                switch (direction) {
                    case 'horizontal':
                        accent.style.top = '20%';
                        accent.style.left = '0';
                        accent.style.width = '100%';
                        accent.style.height = '3px';
                        accent.style.background = `linear-gradient(90deg, transparent, ${secondaryColor}60, transparent)`;
                        break;
                    case 'vertical':
                        accent.style.top = '0';
                        accent.style.left = '20%';
                        accent.style.width = '3px';
                        accent.style.height = '100%';
                        accent.style.background = `linear-gradient(180deg, transparent, ${secondaryColor}60, transparent)`;
                        break;
                    case 'diagonal':
                    default:
                        accent.style.top = '10%';
                        accent.style.right = '10%';
                        accent.style.width = '80px';
                        accent.style.height = '80px';
                        accent.style.background = `radial-gradient(circle, ${secondaryColor}30, transparent 70%)`;
                        accent.style.borderRadius = '50%';
                }
                
                container.appendChild(accent);
            }
            
            // Apply advanced visual effects like shadows, glows, and layering
            function applyAdvancedVisualEffects(container, design) {
                const primaryColor = design.colors[0] || '#0066cc';
                const secondaryColor = design.colors[1] || primaryColor;
                
                // Remove existing effect layers
                const existingEffects = container.querySelectorAll('.visual-effect');
                existingEffects.forEach(effect => effect.remove());
                
                // Apply theme-specific visual effects
                switch (design.theme) {
                    case 'futuristic':
                    case 'tech':
                        applyNeonGlowEffect(container, primaryColor);
                        applyDigitalScanLines(container);
                        break;
                    case 'fire':
                        applyGlowEffect(container, '#ff4500', 'flame');
                        applyFlickerEffect(container);
                        break;
                    case 'ocean':
                    case 'water':
                        applyShimmerEffect(container, primaryColor);
                        applyWaveDistortion(container);
                        break;
                    case 'lightning':
                    case 'electric':
                        applyElectricGlow(container, '#ffff00');
                        applySparkEffect(container);
                        break;
                    case 'galaxy':
                    case 'space':
                        applyCosmicGlow(container, primaryColor);
                        applyStarField(container);
                        break;
                    case 'carbon':
                        applyCarbonTexture(container);
                        applyMetallicShine(container);
                        break;
                    default:
                        // Apply subtle shadow for depth
                        applySubtleShadow(container, primaryColor);
                }
                
                // Apply intensity-based effects
                if (design.intensity === 'high') {
                    applyHighIntensityEffects(container, primaryColor);
                } else if (design.intensity === 'low') {
                    applyLowIntensityEffects(container);
                }
            }
            
            // Neon glow effect for futuristic themes
            function applyNeonGlowEffect(container, color) {
                const glowLayer = document.createElement('div');
                glowLayer.className = 'visual-effect neon-glow';
                glowLayer.style.cssText = `
                    position: absolute;
                    top: -5px;
                    left: -5px;
                    right: -5px;
                    bottom: -5px;
                    background: ${color};
                    filter: blur(8px);
                    opacity: 0.3;
                    z-index: -1;
                    border-radius: inherit;
                    animation: neonPulse 2s ease-in-out infinite alternate;
                `;
                container.appendChild(glowLayer);
                
                // Add CSS animation if not exists
                if (!document.querySelector('#neonAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'neonAnimation';
                    style.textContent = `
                        @keyframes neonPulse {
                            0% { opacity: 0.2; transform: scale(1); }
                            100% { opacity: 0.4; transform: scale(1.02); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Digital scan lines effect
            function applyDigitalScanLines(container) {
                const scanLines = document.createElement('div');
                scanLines.className = 'visual-effect scan-lines';
                scanLines.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: 0;
                    width: 100%;
                    height: 100%;
                    background: repeating-linear-gradient(
                        0deg,
                        transparent,
                        transparent 2px,
                        rgba(0, 255, 255, 0.1) 2px,
                        rgba(0, 255, 255, 0.1) 4px
                    );
                    pointer-events: none;
                    z-index: 3;
                    animation: scanMove 3s linear infinite;
                `;
                container.appendChild(scanLines);
                
                if (!document.querySelector('#scanAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'scanAnimation';
                    style.textContent = `
                        @keyframes scanMove {
                            0% { transform: translateY(-100%); }
                            100% { transform: translateY(100%); }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Shimmer effect for water themes
            function applyShimmerEffect(container, color) {
                const shimmer = document.createElement('div');
                shimmer.className = 'visual-effect shimmer';
                shimmer.style.cssText = `
                    position: absolute;
                    top: 0;
                    left: -100%;
                    width: 100%;
                    height: 100%;
                    background: linear-gradient(
                        90deg,
                        transparent,
                        rgba(255, 255, 255, 0.4),
                        transparent
                    );
                    pointer-events: none;
                    z-index: 2;
                    animation: shimmerMove 3s ease-in-out infinite;
                `;
                container.appendChild(shimmer);
                
                if (!document.querySelector('#shimmerAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'shimmerAnimation';
                    style.textContent = `
                        @keyframes shimmerMove {
                            0% { left: -100%; }
                            50% { left: 100%; }
                            100% { left: 100%; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Electric glow effect
            function applyElectricGlow(container, color) {
                const electricGlow = document.createElement('div');
                electricGlow.className = 'visual-effect electric-glow';
                electricGlow.style.cssText = `
                    position: absolute;
                    top: -3px;
                    left: -3px;
                    right: -3px;
                    bottom: -3px;
                    background: ${color};
                    filter: blur(6px);
                    opacity: 0.6;
                    z-index: -1;
                    border-radius: inherit;
                    animation: electricFlicker 0.1s ease-in-out infinite alternate;
                `;
                container.appendChild(electricGlow);
                
                if (!document.querySelector('#electricAnimation')) {
                    const style = document.createElement('style');
                    style.id = 'electricAnimation';
                    style.textContent = `
                        @keyframes electricFlicker {
                            0% { opacity: 0.4; }
                            25% { opacity: 0.7; }
                            50% { opacity: 0.5; }
                            75% { opacity: 0.8; }
                            100% { opacity: 0.6; }
                        }
                    `;
                    document.head.appendChild(style);
                }
            }
            
            // Subtle shadow for depth
            function applySubtleShadow(container, color) {
                container.style.boxShadow = `0 4px 8px rgba(0, 0, 0, 0.2), 0 0 20px ${color}20`;
            }
            
            // High intensity effects
            function applyHighIntensityEffects(container, color) {
                container.style.filter = 'brightness(1.1) contrast(1.2) saturate(1.3)';
                container.style.boxShadow = `0 0 30px ${color}60, inset 0 0 20px ${color}20`;
            }
            
            // Low intensity effects
            function applyLowIntensityEffects(container) {
                container.style.filter = 'brightness(0.95) contrast(1.05) saturate(0.9)';
                container.style.boxShadow = '0 2px 4px rgba(0, 0, 0, 0.1)';
            }
            
            // Apply color-based visual enhancements
            function applyColorBasedEnhancements(container, colors, theme) {
                if (!colors || colors.length === 0) return;
                
                const primaryColor = colors[0];
                const secondaryColor = colors[1] || colors[0];
                
                // Add subtle border highlights
                const highlight = document.createElement('div');
                highlight.className = 'color-highlight';
                highlight.style.position = 'absolute';
                highlight.style.top = '5%';
                highlight.style.left = '5%';
                highlight.style.right = '5%';
                highlight.style.bottom = '5%';
                highlight.style.border = `2px solid ${secondaryColor}40`;
                highlight.style.borderRadius = '8px';
                highlight.style.pointerEvents = 'none';
                highlight.style.zIndex = '3';
                
                // Add corner accents
                const corners = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
                corners.forEach((corner, index) => {
                    if (index < 2) { // Only add 2 corner accents to avoid clutter
                        const cornerAccent = document.createElement('div');
                        cornerAccent.className = `corner-accent ${corner}`;
                        cornerAccent.style.position = 'absolute';
                        cornerAccent.style.width = '20px';
                        cornerAccent.style.height = '20px';
                        cornerAccent.style.background = `linear-gradient(45deg, ${primaryColor}60, ${secondaryColor}40)`;
                        cornerAccent.style.pointerEvents = 'none';
                        cornerAccent.style.zIndex = '4';
                        
                        if (corner.includes('top')) cornerAccent.style.top = '8%';
                        if (corner.includes('bottom')) cornerAccent.style.bottom = '8%';
                        if (corner.includes('left')) cornerAccent.style.left = '8%';
                        if (corner.includes('right')) cornerAccent.style.right = '8%';
                        
                        if (corner === 'top-left' || corner === 'bottom-right') {
                            cornerAccent.style.clipPath = 'polygon(0 0, 100% 0, 0 100%)';
                        } else {
                            cornerAccent.style.clipPath = 'polygon(100% 0, 100% 100%, 0 100%)';
                        }
                        
                        highlight.appendChild(cornerAccent);
                    }
                });
                
                container.appendChild(highlight);
            }
            
            function generateRandomLogo(position = 'center') {
                // Create a simple SVG logo
                const logoTypes = ['circle', 'star', 'diamond', 'triangle'];
                const logoType = logoTypes[Math.floor(Math.random() * logoTypes.length)];
                const logoColor = '#' + Math.floor(Math.random()*16777215).toString(16);
                
                let svgContent = '';
                switch (logoType) {
                    case 'circle':
                        svgContent = `<circle cx="50" cy="50" r="40" fill="${logoColor}" stroke="white" stroke-width="3"/>`;
                        break;
                    case 'star':
                        svgContent = `<polygon points="50,10 61,35 85,35 67,53 73,77 50,65 27,77 33,53 15,35 39,35" fill="${logoColor}" stroke="white" stroke-width="2"/>`;
                        break;
                    case 'diamond':
                        svgContent = `<polygon points="50,15 75,50 50,85 25,50" fill="${logoColor}" stroke="white" stroke-width="3"/>`;
                        break;
                    case 'triangle':
                        svgContent = `<polygon points="50,15 80,75 20,75" fill="${logoColor}" stroke="white" stroke-width="3"/>`;
                        break;
                }
                
                const svgBlob = new Blob([`<svg width="100" height="100" xmlns="http://www.w3.org/2000/svg">${svgContent}</svg>`], {type: 'image/svg+xml'});
                const url = URL.createObjectURL(svgBlob);
                
                // Create and position logo
                const logoImg = new Image();
                logoImg.onload = function() {
                    // Position logo based on design
                    let top = '20%', left = '50%';
                    switch (position) {
                        case 'chest':
                            top = '15%'; left = '50%';
                            break;
                        case 'center':
                            top = '40%'; left = '50%';
                            break;
                        case 'sleeve':
                            top = '25%'; left = '75%';
                            break;
                    }
                    
                    // Apply to front jersey logo
                    if (frontJerseyLogoImage) {
                        frontJerseyLogoImage.src = url;
                        frontJerseyLogoImage.style.top = top;
                        frontJerseyLogoImage.style.left = left;
                        frontJerseyLogoImage.style.display = 'block';
                    }
                    
                    // Apply to back jersey logo if center position
                    if (backJerseyLogoImage && position === 'center') {
                        backJerseyLogoImage.src = url;
                        backJerseyLogoImage.style.top = top;
                        backJerseyLogoImage.style.left = left;
                        backJerseyLogoImage.style.display = 'block';
                    }
                    
                    URL.revokeObjectURL(url);
                };
                logoImg.src = url;
            }
            
            // Helper function to get CSRF token from cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        // Does this cookie string begin with the name we want?
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
            
            // Enhanced AI features
            const surpriseMeBtn = document.getElementById('surpriseMeBtn');
            const presetButtons = document.querySelectorAll('.preset-btn');
            
            // Preset prompts for different styles
            const stylePresets = {
                cosmic: "Create a cosmic nebula design with swirling galaxies, holographic colors, and stellar particle effects. Use deep space blues, purples, and shimmering silver accents with fractal star patterns.",
                nature: "Design a nature fusion pattern with organic leaf textures, forest gradients from emerald to golden amber, and bio-luminescent accents. Include flowing water patterns and crystalline structures.",
                cyber: "Generate a cyber matrix design with neural network patterns, electric blue and neon green circuits, holographic data streams, and quantum field effects. Add glitch art elements and digital fractals.",
                volcanic: "Create a volcanic fire design with molten lava flows, ember particle effects, obsidian textures, and gradient colors from deep red to bright orange with golden highlights."
            };
            
            // Enhanced random prompts with innovative features
            const innovativePrompts = [
                "Quantum field energy with neural network patterns and holographic rainbow effects",
                "Fractal mandala design with photo-realistic crystal textures and aurora borealis colors",
                "Bio-luminescent ocean waves with tessellation patterns and iridescent color shifting",
                "Cosmic storm with particle effects, nebula clouds, and metallic silver accents",
                "Digital glitch art with chromatic aberration, neon gradients, and geometric fractals",
                "Volcanic glass texture with ember particles and molten metal color mixing",
                "Neural synapse network with electric blue pulses and organic growth patterns",
                "Crystalline structure with prismatic light refraction and rainbow spectrum colors"
            ];
            
            // Preset button event listeners
            presetButtons.forEach(btn => {
                btn.addEventListener('click', function() {
                    const preset = this.dataset.preset;
                    if (stylePresets[preset]) {
                        aiPrompt.value = stylePresets[preset];

                    }
                });
            });
            
            // Surprise Me button
            surpriseMeBtn.addEventListener('click', function() {
                const randomPrompt = innovativePrompts[Math.floor(Math.random() * innovativePrompts.length)];
                aiPrompt.value = randomPrompt;

            });
            
            // Event listeners for AI features
            generateAiDesignBtn.addEventListener('click', async function() {
                const prompt = aiPrompt.value.trim();
                if (!prompt) {
                    alert('Please enter a design description first!');
                    return;
                }
                
                // Show loading state
                aiLoadingSpinner.style.display = 'inline-block';
                generateAiDesignBtn.disabled = true;
                
                try {
                    console.log('Sending AI design request with prompt:', prompt);
                    

                    
                    // Call the enhanced AI API endpoint
                    const response = await fetch('/api/generate-ai-design/', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': getCookie('csrftoken'),
                        },
                        body: JSON.stringify({ 
                            prompt: prompt
                        })
                    });
                    
                    console.log('AI API response status:', response.status);
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const result = await response.json();
                    console.log('AI API result:', result);
                    
                    if (result.success) {
                        // Validate design data
                        if (!result.design) {
                            throw new Error('No design data received from AI');
                        }
                        
                        console.log('Applying AI design:', result.design);
                        
                        // Apply the AI-generated design
                        applyAiDesign(result.design);
                        
                        // Show success message
                        const successMsg = document.createElement('div');
                        successMsg.className = 'alert alert-success mt-2';
                        successMsg.textContent = result.message || 'AI design applied successfully!';
                        successMsg.style.fontSize = '12px';
                        aiPrompt.parentNode.appendChild(successMsg);
                        
                        // Remove success message after 3 seconds
                        setTimeout(() => {
                            if (successMsg.parentNode) {
                                successMsg.parentNode.removeChild(successMsg);
                            }
                        }, 3000);
                    } else {
                        const errorMsg = result.error || 'Failed to generate AI design';
                        console.error('AI generation failed:', errorMsg);
                        throw new Error(errorMsg);
                    }
                } catch (error) {
                    console.error('AI Design Generation Error:', error);
                    
                    // Show error message in UI instead of alert
                    const errorMsg = document.createElement('div');
                    errorMsg.className = 'alert alert-danger mt-2';
                    errorMsg.textContent = 'Error: ' + error.message + '. Please try again or modify your prompt.';
                    errorMsg.style.fontSize = '12px';
                    aiPrompt.parentNode.appendChild(errorMsg);
                    
                    // Remove error message after 5 seconds
                    setTimeout(() => {
                        if (errorMsg.parentNode) {
                            errorMsg.parentNode.removeChild(errorMsg);
                        }
                    }, 5000);
                } finally {
                    // Hide loading state
                    aiLoadingSpinner.style.display = 'none';
                    generateAiDesignBtn.disabled = false;
                }
            });
            
            randomizePromptBtn.addEventListener('click', function() {
                const randomPrompt = innovativePrompts[Math.floor(Math.random() * innovativePrompts.length)];
                aiPrompt.value = randomPrompt;

            });
            

             
             // Drag and Drop functionality
             let draggedElement = null;
             let isDragging = false;
             let dragOffset = { x: 0, y: 0 };
             let selectedElement = null;
             let isResizing = false;
             let resizeHandle = null;
             let elementCounter = 0;
             
             function createDraggableElement(type, content, options = {}) {
                 elementCounter++;
                 const element = document.createElement('div');
                 element.className = 'draggable-element';
                 element.id = `element-${elementCounter}`;
                 element.style.left = options.x || '50px';
                 element.style.top = options.y || '50px';
                 element.style.width = options.width || 'auto';
                 element.style.height = options.height || 'auto';
                 
                 switch (type) {
                     case 'image':
                         const img = document.createElement('img');
                         img.src = content;
                         img.style.maxWidth = '100px';
                         img.style.maxHeight = '100px';
                         img.style.width = '100%';
                         img.style.height = '100%';
                         img.style.objectFit = 'contain';
                         element.appendChild(img);
                         break;
                     case 'text':
                         element.className += ' text-element';
                         element.textContent = content;
                         element.style.fontSize = options.fontSize || '16px';
                         break;
                     case 'shape':
                         element.className += ' shape-element';
                         element.dataset.shape = content;
                         const shapeColor = options.color || document.getElementById('shapeColor').value;
                         element.dataset.color = shapeColor;
                         element.innerHTML = getShapeHTML(content, shapeColor);
                         element.style.width = options.width || '50px';
                         element.style.height = options.height || '50px';
                         break;
                 }
                 
                 // Add event listeners
                 element.addEventListener('mousedown', handleElementMouseDown);
                 element.addEventListener('click', function(e) {
                     e.stopPropagation();
                     selectElement(element);
                 });
                 
                 // Add to apparel container
                 const container = document.getElementById('apparelContainer');
                 container.appendChild(element);
                 
                 // Adjust positioning based on current apparel type
                 if (currentApparelType === 'shorts') {
                     const currentTop = parseInt(element.style.top) || 0;
                     const scaledTop = Math.max(50, currentTop * 0.6 + 100);
                     element.style.top = Math.min(scaledTop, 250) + 'px';
                 }
                 
                 // Update layer list
                 updateLayerList();
                 
                 return element;
             }
             
             function getShapeHTML(shape, color = '#007bff') {
                 const shapes = {
                     circle: `<div style="width: 100%; height: 100%; border-radius: 50%; background: ${color};"></div>`,
                     square: `<div style="width: 100%; height: 100%; background: ${color};"></div>`,
                     triangle: `<div style="width: 0; height: 0; border-left: 25px solid transparent; border-right: 25px solid transparent; border-bottom: 43px solid ${color}; margin: auto;"></div>`,
                     star: `<div style="font-size: 40px; color: ${color}; text-align: center; line-height: 50px;">⭐</div>`,
                     line: `<div style="width: 100%; height: 4px; background: ${color}; margin-top: 23px;"></div>`
                 };
                 return shapes[shape] || shapes.circle;
             }
             
             function handleElementMouseDown(e) {
                 e.preventDefault();
                 e.stopPropagation();
                 
                 const element = e.currentTarget;
                 selectElement(element);
                 
                 if (e.target.classList.contains('resize-handle')) {
                     isResizing = true;
                     resizeHandle = e.target.classList[1]; // get handle position
                     return;
                 }
                 
                 isDragging = true;
                 draggedElement = element;
                 
                 const rect = element.getBoundingClientRect();
                 const containerRect = document.getElementById('apparelContainer').getBoundingClientRect();
                 
                 dragOffset.x = e.clientX - rect.left;
                 dragOffset.y = e.clientY - rect.top;
             }
             
             function handleMouseMove(e) {
                 if (isDragging && draggedElement) {
                     const containerRect = document.getElementById('apparelContainer').getBoundingClientRect();
                     const newX = e.clientX - containerRect.left - dragOffset.x;
                     const newY = e.clientY - containerRect.top - dragOffset.y;
                     
                     draggedElement.style.left = Math.max(0, Math.min(newX, containerRect.width - draggedElement.offsetWidth)) + 'px';
                     draggedElement.style.top = Math.max(0, Math.min(newY, containerRect.height - draggedElement.offsetHeight)) + 'px';
                 }
                 
                 if (isResizing && selectedElement) {
                     const containerRect = document.getElementById('apparelContainer').getBoundingClientRect();
                     const elementRect = selectedElement.getBoundingClientRect();
                     
                     const mouseX = e.clientX - containerRect.left;
                     const mouseY = e.clientY - containerRect.top;
                     
                     const elementLeft = parseInt(selectedElement.style.left);
                     const elementTop = parseInt(selectedElement.style.top);
                     
                     switch (resizeHandle) {
                         case 'bottom-right':
                             const newWidth = mouseX - elementLeft;
                             const newHeight = mouseY - elementTop;
                             selectedElement.style.width = Math.max(20, newWidth) + 'px';
                             selectedElement.style.height = Math.max(20, newHeight) + 'px';
                             break;
                     }
                 }
             }
             
             function handleMouseUp() {
                 isDragging = false;
                 isResizing = false;
                 draggedElement = null;
                 resizeHandle = null;
             }
             
             function selectElement(element) {
                 // Remove selection from all elements
                 document.querySelectorAll('.draggable-element').forEach(el => {
                     el.classList.remove('selected');
                     el.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                 });
                 
                 // Select new element
                 selectedElement = element;
                 element.classList.add('selected');
                 
                 // Add resize handles
                 const handles = ['top-left', 'top-right', 'bottom-left', 'bottom-right'];
                 handles.forEach(position => {
                     const handle = document.createElement('div');
                     handle.className = `resize-handle ${position}`;
                     element.appendChild(handle);
                 });
                 
                 // Update layer list to reflect selection
                 updateLayerList();
             }
             
             function deselectAllElements() {
                 document.querySelectorAll('.draggable-element').forEach(el => {
                     el.classList.remove('selected');
                     el.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                 });
                 selectedElement = null;
             }
             
             function handleImageUpload(files) {
                 Array.from(files).forEach(file => {
                     if (file.type.startsWith('image/')) {
                         const reader = new FileReader();
                         reader.onload = function(e) {
                             createDraggableElement('image', e.target.result, {
                                 x: Math.random() * 200 + 50 + 'px',
                                 y: Math.random() * 200 + 50 + 'px'
                             });
                         };
                         reader.readAsDataURL(file);
                     }
                 });
             }
             
             function addTextElement(text) {
                 if (text.trim()) {
                     createDraggableElement('text', text, {
                         x: Math.random() * 200 + 50 + 'px',
                         y: Math.random() * 200 + 50 + 'px'
                     });
                 }
             }
             
             function addShapeElement(shape) {
                 createDraggableElement('shape', shape, {
                     x: Math.random() * 200 + 50 + 'px',
                     y: Math.random() * 200 + 50 + 'px',
                     width: '50px',
                     height: '50px'
                 });
             }
             
             function clearAllElements() {
                 document.querySelectorAll('.draggable-element').forEach(el => el.remove());
                 selectedElement = null;
                 updateLayerList();
             }
             
             // Layer Management Functions
             function updateLayerList() {
                 const layerList = document.getElementById('layerList');
                 const elements = document.querySelectorAll('.draggable-element');
                 
                 layerList.innerHTML = '';
                 
                 if (elements.length === 0) {
                     layerList.innerHTML = '<div class="layer-empty">No elements added yet</div>';
                     return;
                 }
                 
                 elements.forEach((element, index) => {
                     const layerItem = document.createElement('div');
                     layerItem.className = 'layer-item';
                     if (element === selectedElement) {
                         layerItem.classList.add('selected');
                     }
                     
                     const preview = document.createElement('div');
                     preview.className = 'layer-preview';
                     
                     const info = document.createElement('div');
                     info.className = 'layer-info';
                     
                     if (element.classList.contains('text-element')) {
                         preview.textContent = 'T';
                         info.textContent = `Text: ${element.textContent.substring(0, 20)}...`;
                     } else if (element.classList.contains('shape-element')) {
                         preview.textContent = '◆';
                         info.textContent = `Shape: ${element.dataset.shape || 'Unknown'}`;
                     } else {
                         preview.textContent = '🖼';
                         info.textContent = 'Image';
                     }
                     
                     const visibility = document.createElement('div');
                     visibility.className = 'layer-visibility';
                     visibility.innerHTML = '👁';
                     visibility.onclick = () => toggleElementVisibility(element);
                     
                     layerItem.appendChild(preview);
                     layerItem.appendChild(info);
                     layerItem.appendChild(visibility);
                     
                     layerItem.onclick = () => selectElement(element);
                     
                     layerList.appendChild(layerItem);
                 });
             }
             
             function moveLayerUp() {
                 if (!selectedElement) return;
                 
                 const container = document.getElementById('apparelContainer');
                 const elements = Array.from(container.querySelectorAll('.draggable-element'));
                 const currentIndex = elements.indexOf(selectedElement);
                 
                 if (currentIndex < elements.length - 1) {
                     const nextElement = elements[currentIndex + 1];
                     container.insertBefore(selectedElement, nextElement.nextSibling);
                     updateLayerList();
                 }
             }
             
             function moveLayerDown() {
                 if (!selectedElement) return;
                 
                 const container = document.getElementById('apparelContainer');
                 const elements = Array.from(container.querySelectorAll('.draggable-element'));
                 const currentIndex = elements.indexOf(selectedElement);
                 
                 if (currentIndex > 0) {
                     const prevElement = elements[currentIndex - 1];
                     container.insertBefore(selectedElement, prevElement);
                     updateLayerList();
                 }
             }
             
             function duplicateLayer() {
                 if (!selectedElement) return;
                 
                 const clone = selectedElement.cloneNode(true);
                 clone.style.left = (parseInt(selectedElement.style.left) + 20) + 'px';
                 clone.style.top = (parseInt(selectedElement.style.top) + 20) + 'px';
                 
                 // Remove resize handles from clone
                 clone.querySelectorAll('.resize-handle').forEach(handle => handle.remove());
                 clone.classList.remove('selected');
                 
                 // Add event listeners to clone
                 clone.addEventListener('mousedown', function(e) {
                     if (e.target.classList.contains('resize-handle')) {
                         isResizing = true;
                         resizeHandle = e.target.classList[1];
                         return;
                     }
                     selectElement(clone);
                     handleElementMouseDown(e, clone);
                 });
                 
                 document.getElementById('apparelContainer').appendChild(clone);
                 selectElement(clone);
                 updateLayerList();
             }
             
             function deleteLayer() {
                 if (!selectedElement) return;
                 
                 selectedElement.remove();
                 selectedElement = null;
                 updateLayerList();
             }
             
             function toggleElementVisibility(element) {
                 if (element.style.display === 'none') {
                     element.style.display = 'block';
                 } else {
                     element.style.display = 'none';
                 }
                 updateLayerList();
             }
                 
                 // Global mouse events for drag and drop
                 document.addEventListener('mousemove', handleMouseMove);
                 document.addEventListener('mouseup', handleMouseUp);
                 
                 // Click outside to deselect
                 document.getElementById('apparelContainer').addEventListener('click', function(e) {
                     if (e.target === this) {
                         deselectAllElements();
                     }
                 });
                 
                 // Image upload
                 document.getElementById('imageUpload').addEventListener('change', function(e) {
                     handleImageUpload(e.target.files);
                 });
                 
                 // Add text button
                 document.getElementById('addTextBtn').addEventListener('click', function() {
                     const textInput = document.getElementById('textInput');
                     addTextElement(textInput.value);
                     textInput.value = '';
                 });
                 
                 // Text input enter key
                 document.getElementById('textInput').addEventListener('keypress', function(e) {
                     if (e.key === 'Enter') {
                         addTextElement(this.value);
                         this.value = '';
                     }
                 });
                 
                 // Shape buttons
                 document.querySelectorAll('[data-shape]').forEach(btn => {
                     btn.addEventListener('click', function() {
                         addShapeElement(this.dataset.shape);
                     });
                 });
                 
                 // Clear elements button
                 document.getElementById('clearElements').addEventListener('click', clearAllElements);
                 
                 // Shape color controls
                 document.getElementById('applyShapeColor').addEventListener('click', function() {
                     if (selectedElement && selectedElement.classList.contains('shape-element')) {
                         const newColor = document.getElementById('shapeColor').value;
                         const shape = selectedElement.dataset.shape;
                         selectedElement.dataset.color = newColor;
                         selectedElement.innerHTML = getShapeHTML(shape, newColor);
                     }
                 });
                 
                 // Delete selected element with Delete key
                 document.addEventListener('keydown', function(e) {
                     if (e.key === 'Delete' && selectedElement) {
                         selectedElement.remove();
                         selectedElement = null;
                         updateLayerList();
                     }
                 });
                 
                 // Layer management buttons
                 document.getElementById('moveLayerUp').addEventListener('click', moveLayerUp);
                 document.getElementById('moveLayerDown').addEventListener('click', moveLayerDown);
                 document.getElementById('duplicateLayer').addEventListener('click', duplicateLayer);
                 document.getElementById('deleteLayer').addEventListener('click', deleteLayer);
             
             // Initialize
            updateRotation();
            updatePlayerName();
            updatePlayerNumber();
            updateTextColor(textColor.value);
            updateGradientPreview();
        });
    </script>
    
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>