<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>GearCraftWorks | Customize</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .navbar {
            background-color: #007bff;
        }

        .navbar a {
            color: white;
        }

        .container {
            margin-top: 20px;
        }

        #tshirt-div {
            width: 100%;
            max-width: 452px;
            height: 548px;
            background-color: #fff;
            position: relative;
            margin: 25px auto;
            border: 5px solid #ccc;
            border-radius: 8px;
            overflow: hidden;
        }

        #tshirt-backgroundpicture {
            width: 100%;
            height: auto;
        }

        .drawing-area {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 10;
        }

        .canvas-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        #tshirt-canvas {
            width: 100%;
            height: 100%;
            border: 1px solid #ccc;
        }

        .functions {
            margin-top: 20px;
        }

        .functions label {
            font-weight: bold;
        }

        .functions input, .functions select, .functions button {
            margin-top: 10px;
            margin-bottom: 10px;
        }

        .functions button {
            background: #007bff;
            color: white;
            border: none;
            border-radius: 5px;
            padding: 10px 20px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .functions button:hover {
            background: #0056b3;
        }

        .functions .btn-secondary {
            background: #6c757d;
        }

        .functions .btn-secondary:hover {
            background: #5a6268;
        }
    </style>
</head>
<body>
    <header>
    </header>
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">WorksTeamWear</a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </div>
        </div>
    </nav>
    
    <div class="container">
        <div id="tshirt-div">
            <img id="tshirt-backgroundpicture" src="https://ourcodeworld.com/public-media/gallery/gallery-5d5afd3f1c7d6.png" onload="imageLoaded()" onerror="imageError()"/>
            <div id="drawingArea" class="drawing-area">					
                <div class="canvas-container">
                    <canvas id="tshirt-canvas" width="200" height="400"></canvas>
                </div>
            </div>
        </div>
        <div class="functions">
            <p>Remove your Uploaded image by clicking the <kbd>DEL</kbd> key.</p>
            
            <div class="form-group">
                <label for="tshirt-color">T-Shirt Color:</label>
                <select id="tshirt-color" class="form-control">
                    <option value="#fff">White</option>
                    <option value="#000">Black</option>
                    <option value="#f00">Red</option>
                    <option value="#008000">Green</option>
                    <option value="#ff0">Yellow</option>
                </select>
            </div>

            <div class="form-group">
                <label for="tshirt-custompicture">Upload your own logo/design:</label>
                <input type="file" id="tshirt-custompicture" class="form-control-file" />
            </div>

            <div class="form-group">
                <label for="text-input">Add Text:</label>
                <input type="text" id="text-input" class="form-control" placeholder="Enter text">
                <button id="add-text-btn" class="btn btn-primary mt-2">Add Text</button>
            </div>

            <div class="form-group">
                <label for="font-select">Font:</label>
                <select id="font-select" class="form-control">
                    <option value="Arial">Arial</option>
                    <option value="Times New Roman">Times New Roman</option>
                    <option value="cursive">Cursive</option>
                </select>
            </div>

            <div class="form-group">
                <label for="font-size">Font Size:</label>
                <input type="number" id="font-size" class="form-control" value="20">
            </div>

            <div class="form-group">
                <label for="text-color">Text Color:</label>
                <input type="color" id="text-color" class="form-control">
            </div>

            <div class="form-group">
                <label for="brush-size">Brush Size:</label>
                <input type="number" id="brush-size" class="form-control" value="1">
                <div class="form-check">
                    <input type="checkbox" id="toggle-paint-mode" class="form-check-input">
                    <label for="toggle-paint-mode" class="form-check-label">Toggle Paint Mode</label>
                </div>
            </div>

            <div class="form-group">
                <label for="brush-color">Brush Color:</label>
                <input type="color" id="brush-color" class="form-control">
            </div>

            <button id="delete-paint-btn" class="btn btn-secondary">Delete Paint</button>
            <button id="download-btn" class="btn btn-success mt-2">Download Design</button>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.4/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.6.3/fabric.min.js'></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js'></script>
    <script>
        let canvas = new fabric.Canvas('tshirt-canvas');
        let paintMode = false;
        let imageLoadedFlag = false;

        function imageLoaded() {
            imageLoadedFlag = true;
            console.log('T-shirt image loaded successfully.');
        }

        function imageError() {
            console.error('Error loading t-shirt image.');
            alert('Error loading t-shirt image.');
        }

        function togglePaintMode() {
            paintMode = !paintMode;
            if (paintMode) {
                canvas.isDrawingMode = true;
                updateBrushColor(document.getElementById("brush-color").value);
                canvas.freeDrawingBrush.width = parseInt(document.getElementById("brush-size").value, 10) || 1;
                canvas.selection = false; // Disable object selection in paint mode
            } else {
                canvas.isDrawingMode = false;
                canvas.selection = true; // Enable object selection
            }
        }

        document.getElementById("toggle-paint-mode").addEventListener("click", function() {
            togglePaintMode();
        });

        document.getElementById("tshirt-color").addEventListener("change", function(){
            document.getElementById("tshirt-div").style.backgroundColor = this.value;
            if (!paintMode) {
                updateBrushColor(document.getElementById("brush-color").value);
            }
        }, false);

        document.getElementById("brush-color").addEventListener("input", function() {
            updateBrushColor(this.value);
        });

        document.getElementById("brush-size").addEventListener("change", function(){
            if (paintMode) {
                canvas.freeDrawingBrush.width = parseInt(this.value, 10) || 1;
            }
        }, false);

        document.getElementById("delete-paint-btn").addEventListener("click", function() {
            deletePaint();
        });

        document.getElementById('tshirt-custompicture').addEventListener("change", function(e){
            var reader = new FileReader();
            
            reader.onload = function (event){
                var imgObj = new Image();
                imgObj.src = event.target.result;

                imgObj.onload = function () {
                    var img = new fabric.Image(imgObj);

                    img.scaleToHeight(300);
                    img.scaleToWidth(300); 
                    canvas.centerObject(img);
                    canvas.add(img);
                    canvas.renderAll();
                };
            };

            if(e.target.files[0]){
                reader.readAsDataURL(e.target.files[0]);
            }
        }, false);

        document.addEventListener("keydown", function(e) {
            var keyCode = e.keyCode;

            if(keyCode == 46){
                console.log("Removing selected element on Fabric.js on DELETE key !");
                canvas.remove(canvas.getActiveObject());
            }
        }, false);

        document.getElementById('add-text-btn').addEventListener('click', function() {
            var textInput = document.getElementById('text-input').value.trim(); // Trim to remove spaces
            if (!textInput) {
                alert('Please enter text to add.');
                return; // Stop if input is empty
            }

            var font = document.getElementById('font-select').value || 'Arial'; // Default to Arial if empty
            var fontSize = parseInt(document.getElementById('font-size').value, 10) || 20; // Default to 20
            var textColor = document.getElementById('text-color').value || '#000000'; // Default to black

            var text = new fabric.Text(textInput, {
                fontFamily: font,
                fontSize: fontSize,
                fill: textColor,
                left: 100,
                top: 100
            });

            canvas.add(text);
            canvas.renderAll();
        });

        // Update color of selected text object
        document.getElementById("text-color").addEventListener("input", function() {
            var activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'text') {
                activeObject.set("fill", this.value); // Update color of selected text
                canvas.renderAll();
            }
        });

        function updateBrushColor(color) {
            canvas.freeDrawingBrush.color = color;
        }

        function deletePaint() {
            var objects = canvas.getObjects();
            var paintObjects = objects.filter(function(obj) {
                return obj.type === 'path';
            });
            paintObjects.forEach(function(obj) {
                canvas.remove(obj);
            });
            canvas.renderAll();
        }

        document.getElementById('download-btn').addEventListener('click', function() {
            console.log('Download button clicked');
            const tshirtDiv = document.getElementById('tshirt-div');
            if (!tshirtDiv) {
                console.error('Element with ID "tshirt-div" not found');
                alert('Element with ID "tshirt-div" not found');
                return;
            }

            if (!imageLoadedFlag) {
                console.error('T-shirt image not loaded yet.');
                alert('T-shirt image not loaded yet. Please wait for the image to load.');
                return;
            }

            captureDesign();
        });

        function captureDesign() {
            const tshirtDiv = document.getElementById('tshirt-div');
            console.log('Capturing design...');
            html2canvas(tshirtDiv).then(function(canvas) {
                console.log('Canvas captured:', canvas);
                canvas.toBlob(function(blob) {
                    var link = document.createElement('a');
                    link.download = 'tshirt-design.png';
                    link.href = URL.createObjectURL(blob);
                    link.click();
                });
            }).catch(function(error) {
                console.error('Error capturing image:', error);
                alert('An error occurred while capturing the design. Please ensure all images are from the same origin.');
            });
        }
    </script>
</body>
</html>